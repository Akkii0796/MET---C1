<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Expense Tracker</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 150px;
        }

        .tab-button.active {
            background: white;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
        }

        .tab-button:hover {
            background: #e9ecef;
            color: #2c3e50;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 22px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        /* Budget Summary Styles */
        .budget-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .budget-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .budget-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .budget-card .amount {
            font-size: 24px;
            font-weight: bold;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: all 0.5s ease;
            border-radius: 10px;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #ffc107, #fd7e14);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #dc3545, #e74c3c);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-item input[type="radio"] {
            width: auto;
            margin: 0;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #218838);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
            margin: 2px;
        }

        /* Chart Styles */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        /* Top Lists */
        .top-lists {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .top-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .top-list h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .top-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .top-item:last-child {
            border-bottom: none;
        }

        /* Search Filters */
        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Messages */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: 500;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #3498db;
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }

            .tab-content {
                padding: 15px;
            }

            .section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .budget-summary {
                grid-template-columns: 1fr;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn-group .btn {
                width: 100%;
            }

            .filter-group {
                grid-template-columns: 1fr;
            }

            .tabs {
                justify-content: flex-start;
            }

            .tab-button {
                min-width: 120px;
                font-size: 14px;
                padding: 12px 16px;
            }

            /* Mobile Table Styles */
            .table-container {
                font-size: 14px;
            }

            table, thead, tbody, th, td, tr {
                display: block;
            }

            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr {
                border: 1px solid #ccc;
                margin-bottom: 10px;
                padding: 10px;
                border-radius: 8px;
                background: white;
            }

            td {
                border: none;
                position: relative;
                padding-left: 30%;
                padding-bottom: 10px;
                padding-top: 10px;
            }

            td:before {
                content: attr(data-label) ": ";
                position: absolute;
                left: 6px;
                width: 25%;
                font-weight: bold;
                color: #2c3e50;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 24px;
            }

            .header p {
                font-size: 14px;
            }

            .budget-card .amount {
                font-size: 20px;
            }

            .section h2 {
                font-size: 18px;
            }
        }

        /* Local Storage Status (replaces Firebase connection status) */
        .storage-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }

        .storage-status.ok {
            background: #28a745;
            color: white;
        }

        .storage-status.warning {
            background: #ffc107;
            color: #333;
        }

        .storage-status.error {
            background: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="storage-status" id="storageStatus">Checking storage...</div>
        
        <div class="header">
            <h1>💰 Monthly Expense Tracker</h1>
            <p>Track your expenses, manage your budget, and gain insights into your spending habits</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('dashboard', event)">📊 Dashboard</button>
            <button class="tab-button" onclick="showTab('summary', event)">📈 Summary</button>
            <button class="tab-button" onclick="showTab('search', event)">🔍 Search & History</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="section">
                <h2>Budget Summary</h2>
                <div class="budget-summary">
                    <div class="budget-card">
                        <h3>Total Budget</h3>
                        <div class="amount" id="totalBudget">₹0</div>
                    </div>
                    <div class="budget-card">
                        <h3>Total Spent</h3>
                        <div class="amount" id="totalSpent">₹0</div>
                    </div>
                    <div class="budget-card">
                        <h3>Remaining</h3>
                        <div class="amount" id="remainingBudget">₹0</div>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="budgetProgress"></div>
                    </div>
                    <p id="progressText">Budget utilization: 0%</p>
                </div>

                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px;">
                    <div style="flex: 1; min-width: 200px;">
                        <input type="number" id="newBudget" placeholder="Enter new monthly budget" min="0" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px;">
                    </div>
                    <button class="btn" onclick="setBudget()">Set Budget</button>
                    <button class="btn btn-secondary" onclick="resetBudget()">Reset Budget</button>
                </div>
            </div>

            <div class="section">
                <h2>Add New Expense</h2>
                <form id="expenseForm">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label>Recorded By</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="akshay" name="recordedBy" value="Akshay" checked>
                                    <label for="akshay">Akshay</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="achal" name="recordedBy" value="Achal">
                                    <label for="achal">Achal</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="category">Category</label>
                            <select id="category" required>
                                <option value="">Select Category</option>
                                <option value="Grocery">Grocery</option>
                                <option value="Bills">Bills</option>
                                <option value="Travelling">Travelling</option>
                                <option value="Food">Food</option>
                                <option value="Medical">Medical</option>
                                <option value="EMI">EMI</option>
                                <option value="Investment">Investment</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Personal Care">Personal Care</option>
                                <option value="Education">Education</option>
                                <option value="Gifts/Donations">Gifts/Donations</option>
                                <option value="Home Maintenance">Home Maintenance</option>
                                <option value="Transportation">Transportation</option>
                                <option value="Utilities">Utilities</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="vendor">Vendor</label>
                            <input type="text" id="vendor" required placeholder="Enter vendor name">
                        </div>

                        <div class="form-group">
                            <label for="amount">Amount (₹)</label>
                            <input type="number" id="amount" required min="0" step="0.01" placeholder="0.00">
                        </div>

                        <div class="form-group">
                            <label for="date">Date</label>
                            <input type="date" id="date" required>
                        </div>

                        </div>

                    <div class="form-group">
                        <label for="note">Note (Optional)</label>
                        <textarea id="note" rows="3" placeholder="Add any additional notes..."></textarea>
                    </div>

                    <button type="submit" class="btn" id="addExpenseBtn">Add Expense</button>
                </form>
            </div>

            <div class="section">
                <h2>Recent Expenses</h2>
                <div class="btn-group" style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="downloadCSV()">📄 Download All CSV</button>
                    <button class="btn btn-success" onclick="downloadPDF()">📄 Download All PDF</button>
                </div>
                
                <div class="table-container">
                    <table id="recentExpensesTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Recorded By</th>
                                <th>Category</th>
                                <th>Vendor</th>
                                <th>Amount</th>
                                <th>Note</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                
                <div class="pagination">
                    <button id="prevPage" onclick="changePage(-1)">Previous</button>
                    <span id="pageInfo">Page 1 of 1</span>
                    <button id="nextPage" onclick="changePage(1)">Next</button>
                </div>
            </div>
        </div>

        <div id="summary" class="tab-content">
            <div class="section">
                <h2>Spending Analytics</h2>
                <div class="chart-grid">
                    <div class="chart-container">
                        <canvas id="categoryPieChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="monthlyTrendChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="dailySpendingChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="weeklyTrendChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="categoryCountChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="userSpendingChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Top Spending Insights</h2>
                <div class="top-lists">
                    <div class="top-list">
                        <h3>🏆 Top 3 Categories</h3>
                        <div id="topCategories">
                            </div>
                    </div>
                    <div class="top-list">
                        <h3>🏪 Top 3 Vendors</h3>
                        <div id="topVendors">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="search" class="tab-content">
            <div class="section">
                <h2>Search & Filter Expenses</h2>
                <div class="filter-group">
                    <div class="form-group">
                        <label for="searchText">Search</label>
                        <input type="text" id="searchText" placeholder="Search by vendor, category, note, or user...">
                    </div>
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate">
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn" onclick="searchExpenses()">🔍 Search</button>
                    <button class="btn btn-secondary" onclick="clearFilters()">🔄 Clear Filters</button>
                    <button class="btn btn-success" onclick="downloadFilteredCSV()">📄 Download Filtered CSV</button>
                    <button class="btn btn-success" onclick="downloadFilteredPDF()">📄 Download Filtered PDF</button>
                </div>
            </div>

            <div class="section">
                <h2>Search Results</h2>
                <div class="table-container">
                    <table id="searchResultsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Recorded By</th>
                                <th>Category</th>
                                <th>Vendor</th>
                                <th>Amount</th>
                                <th>Note</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <div id="searchMessage" class="message info" style="display: none;">
                    Use the search filters above to find specific expenses.
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== LOCAL STORAGE CONFIGURATION ====================
        const EXPENSES_STORAGE_KEY = 'monthly_expense_tracker_expenses';
        const BUDGET_STORAGE_KEY = 'monthly_expense_tracker_budget';

        // Global variables
        let currentExpenses = [];
        let currentBudget = 0;
        let filteredExpenses = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let charts = {};

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            document.getElementById('date').valueAsDate = new Date();
            
            // Initialize the app
            initializeApp();
            
            // Set up form submission
            document.getElementById('expenseForm').addEventListener('submit', handleExpenseSubmission);
        });

        function initializeApp() {
            try {
                checkLocalStorageAvailability();
                loadDataFromLocalStorage();
                updateDisplay();
            } catch (error) {
                console.error('Error initializing app:', error);
                updateStorageStatus('error');
                showMessage('Failed to initialize app. Local storage might be unavailable or full.', 'error');
            }
        }

        function checkLocalStorageAvailability() {
            const statusEl = document.getElementById('storageStatus');
            try {
                const test = 'test';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                updateStorageStatus('ok');
            } catch (e) {
                updateStorageStatus('error');
                showMessage('Local Storage is not available. Data will not be saved.', 'error');
            }
        }

        function updateStorageStatus(status) {
            const statusEl = document.getElementById('storageStatus');
            statusEl.textContent = ''; // Clear text
            statusEl.className = `storage-status ${status}`;
            if (status === 'ok') {
                statusEl.textContent = '🟢 Local Storage OK';
            } else if (status === 'warning') {
                statusEl.textContent = '🟡 Local Storage Warning';
            } else if (status === 'error') {
                statusEl.textContent = '🔴 Local Storage Error';
            }
        }

        // ==================== LOCAL STORAGE DATA MANAGEMENT ====================
        function saveExpensesToLocalStorage() {
            try {
                localStorage.setItem(EXPENSES_STORAGE_KEY, JSON.stringify(currentExpenses));
                updateStorageStatus('ok');
            } catch (e) {
                console.error('Error saving expenses to local storage:', e);
                updateStorageStatus('error');
                showMessage('Error saving expenses. Local storage might be full.', 'error');
            }
        }

        function loadExpensesFromLocalStorage() {
            try {
                const storedExpenses = localStorage.getItem(EXPENSES_STORAGE_KEY);
                currentExpenses = storedExpenses ? JSON.parse(storedExpenses) : [];
                // Ensure timestamp is treated as a number for sorting consistency
                currentExpenses.forEach(expense => {
                    if (typeof expense.timestamp === 'string') {
                        expense.timestamp = new Date(expense.timestamp).getTime();
                    }
                });
                updateStorageStatus('ok');
            } catch (e) {
                console.error('Error loading expenses from local storage:', e);
                updateStorageStatus('error');
                currentExpenses = []; // Clear in case of corrupted data
                showMessage('Error loading expenses. Data might be corrupted.', 'error');
            }
        }

        function saveBudgetToLocalStorage() {
            try {
                localStorage.setItem(BUDGET_STORAGE_KEY, JSON.stringify(currentBudget));
                updateStorageStatus('ok');
            } catch (e) {
                console.error('Error saving budget to local storage:', e);
                updateStorageStatus('error');
                showMessage('Error saving budget. Local storage might be full.', 'error');
            }
        }

        function loadBudgetFromLocalStorage() {
            try {
                const storedBudget = localStorage.getItem(BUDGET_STORAGE_KEY);
                currentBudget = storedBudget ? parseFloat(JSON.parse(storedBudget)) : 0;
                if (isNaN(currentBudget)) currentBudget = 0;
                updateStorageStatus('ok');
            } catch (e) {
                console.error('Error loading budget from local storage:', e);
                updateStorageStatus('error');
                currentBudget = 0; // Clear in case of corrupted data
                showMessage('Error loading budget. Data might be corrupted.', 'error');
            }
        }

        function loadDataFromLocalStorage() {
            loadExpensesFromLocalStorage();
            loadBudgetFromLocalStorage();
        }

        // ==================== BUDGET MANAGEMENT ====================
        function setBudget() {
            const budgetInput = document.getElementById('newBudget');
            const amount = parseFloat(budgetInput.value);
            
            if (isNaN(amount) || amount < 0) {
                showMessage('Please enter a valid positive budget amount', 'error');
                return;
            }
            
            currentBudget = amount;
            saveBudgetToLocalStorage();
            budgetInput.value = '';
            showMessage('✅ Budget updated successfully!', 'success');
            updateBudgetDisplay();
        }

        function resetBudget() {
            if (!confirm('Are you sure you want to reset the budget to zero? This action cannot be undone.')) {
                return;
            }
            
            currentBudget = 0;
            saveBudgetToLocalStorage();
            showMessage('✅ Budget reset successfully!', 'success');
            updateBudgetDisplay();
        }

        function updateBudgetDisplay() {
            const totalBudget = currentBudget;
            const totalSpent = calculateTotalSpent();
            const remaining = totalBudget - totalSpent;
            
            document.getElementById('totalBudget').textContent = `₹${totalBudget.toLocaleString('en-IN')}`;
            document.getElementById('totalSpent').textContent = `₹${totalSpent.toLocaleString('en-IN')}`;
            document.getElementById('remainingBudget').textContent = `₹${remaining.toLocaleString('en-IN')}`;
            
            // Update progress bar
            const percentage = totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0;
            const progressFill = document.getElementById('budgetProgress');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = `${Math.min(percentage, 100)}%`;
            progressText.textContent = `Budget utilization: ${percentage.toFixed(1)}%`;
            
            // Update progress bar color
            progressFill.className = 'progress-fill'; // Reset classes first
            if (percentage >= 90) {
                progressFill.classList.add('danger');
            } else if (percentage >= 70) {
                progressFill.classList.add('warning');
            }
        }

        function calculateTotalSpent() {
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM format
            return currentExpenses
                .filter(expense => expense.date.startsWith(currentMonth))
                .reduce((total, expense) => total + expense.amount, 0);
        }

        // ==================== EXPENSE MANAGEMENT ====================
        function handleExpenseSubmission(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('addExpenseBtn');
            const originalText = submitBtn.textContent;
            
            // Show loading state and disable button early for immediate feedback
            submitBtn.innerHTML = '<span class="loading"></span>Adding...';
            submitBtn.disabled = true;

            try {
                // Validate form
                const recordedBy = document.querySelector('input[name="recordedBy"]:checked').value;
                const category = document.getElementById('category').value;
                const vendor = document.getElementById('vendor').value.trim();
                const amount = parseFloat(document.getElementById('amount').value);
                const date = document.getElementById('date').value;
                const note = document.getElementById('note').value.trim();
                // Receipt upload is removed for local storage implementation
                
                if (!category || !vendor || isNaN(amount) || amount <= 0 || !date) {
                    showMessage('Please fill in all required fields (Category, Vendor, positive Amount, Date)', 'error');
                    return; // Stop execution if validation fails
                }
                
                const newExpense = {
                    id: Date.now().toString(), // Unique ID for each expense
                    recordedBy,
                    category,
                    vendor,
                    amount,
                    date, // YYYY-MM-DD format
                    note,
                    receiptUrl: '', // No direct receipt URL with local storage
                    filePath: '', // No file path with local storage
                    timestamp: Date.now() // For ordering
                };

                currentExpenses.push(newExpense);
                saveExpensesToLocalStorage();
                
                // Reset form
                document.getElementById('expenseForm').reset();
                document.getElementById('date').valueAsDate = new Date(); // Reset date to current
                document.querySelector('input[name="recordedBy"][value="Akshay"]').checked = true; // Default radio
                
                showMessage('✅ Expense added successfully!', 'success');
                updateDisplay(); // Re-render all data displays
                
            } catch (error) {
                console.error('Error adding expense:', error);
                showMessage('Error adding expense. Please try again.', 'error');
            } finally {
                // IMPORTANT: Always reset button state regardless of success or failure
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        function deleteExpense(expenseId) {
            if (!confirm('Are you sure you want to delete this expense? This action cannot be undone.')) {
                return;
            }
            
            const initialLength = currentExpenses.length;
            currentExpenses = currentExpenses.filter(expense => expense.id !== expenseId);
            
            if (currentExpenses.length < initialLength) {
                saveExpensesToLocalStorage();
                showMessage('✅ Expense deleted successfully!', 'success');
                updateDisplay(); // Re-render all data displays
            } else {
                showMessage('Expense not found.', 'error');
            }
        }

        // ==================== DISPLAY FUNCTIONS ====================
        function updateDisplay() {
            updateBudgetDisplay();
            renderRecentExpenses();
            // Charts and Top Lists are rendered when summary tab is opened
            // Search results are rendered when search tab is opened or search is performed
            // No real-time listeners, so manual updates are crucial after any data change.
        }

        function renderRecentExpenses() {
            const tbody = document.querySelector('#recentExpensesTable tbody');
            // Make a copy and sort by timestamp in descending order (most recent first)
            const sortedExpenses = [...currentExpenses].sort((a, b) => b.timestamp - a.timestamp);

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageExpenses = sortedExpenses.slice(startIndex, endIndex); // Use sorted expenses for pagination
            
            if (pageExpenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #6c757d;">No expenses found. Add a new expense to get started!</td></tr>';
            } else {
                tbody.innerHTML = pageExpenses.map(expense => `
                    <tr>
                        <td data-label="Date">${formatDate(expense.date)}</td>
                        <td data-label="Recorded By">${expense.recordedBy}</td>
                        <td data-label="Category">${expense.category}</td>
                        <td data-label="Vendor">${expense.vendor}</td>
                        <td data-label="Amount">₹${expense.amount.toLocaleString('en-IN')}</td>
                        <td data-label="Note">${expense.note || '-'}</td>
                        <td data-label="Actions">
                            <button class="btn btn-danger btn-small" onclick="deleteExpense('${expense.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            }
            
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.max(1, Math.ceil(currentExpenses.length / itemsPerPage)); // Ensure at least 1 page
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        }

        function changePage(direction) {
            const totalPages = Math.max(1, Math.ceil(currentExpenses.length / itemsPerPage));
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderRecentExpenses();
            } else if (newPage < 1) { // Loop back to last page if going before first
                currentPage = totalPages;
                renderRecentExpenses();
            } else if (newPage > totalPages) { // Loop back to first page if going after last
                currentPage = 1;
                renderRecentExpenses();
            }
        }

        // ==================== CHART FUNCTIONS ====================
        // Ensure Chart.js and Datalabels plugin are loaded before calling this
        Chart.register(ChartDataLabels);

        function renderCharts() {
            // Destroy existing chart instances before re-rendering
            for (const chartKey in charts) {
                if (charts[chartKey]) {
                    charts[chartKey].destroy();
                    charts[chartKey] = null; // Clear reference
                }
            }

            renderCategoryPieChart();
            renderMonthlyTrendChart();
            renderDailySpendingChart();
            renderWeeklyTrendChart();
            renderCategoryCountChart();
            renderUserSpendingChart();
        }

        function renderCategoryPieChart() {
            const ctx = document.getElementById('categoryPieChart').getContext('2d');
            
            const categoryData = {};
            currentExpenses.forEach(expense => {
                categoryData[expense.category] = (categoryData[expense.category] || 0) + expense.amount;
            });
            
            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);

            if (labels.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Segoe UI';
                ctx.fillStyle = '#6c757d';
                ctx.textAlign = 'center';
                ctx.fillText('No spending data for categories yet.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#C9CBCF', '#A3E4D7', '#F1948A', '#85C1E9',
                '#FAD7A0', '#D7BDE2', '#AF7AC5', '#5DADE2', '#48C9B0', '#F7DC6F'
            ];
            
            charts.categoryPie = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Spending by Category',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        datalabels: {
                            formatter: (value, ctx) => {
                                const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / sum) * 100).toFixed(1);
                                if (percentage > 5) { // Only show percentage if it's significant
                                    return `${percentage}%`;
                                } else {
                                    return '';
                                }
                            },
                            color: '#fff',
                            font: { weight: 'bold', size: 10 },
                            textShadowColor: 'rgba(0,0,0,0.5)',
                            textShadowBlur: 4,
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderMonthlyTrendChart() {
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
            
            const monthlyData = {};
            currentExpenses.forEach(expense => {
                const month = expense.date.slice(0, 7); // YYYY-MM
                monthlyData[month] = (monthlyData[month] || 0) + expense.amount;
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            const data = sortedMonths.map(month => monthlyData[month]);

            if (sortedMonths.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Segoe UI';
                ctx.fillStyle = '#6c757d';
                ctx.textAlign = 'center';
                ctx.fillText('No spending data for monthly trend yet.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            charts.monthlyTrend = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedMonths.map(month => {
                        const date = new Date(month + '-01');
                        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                    }),
                    datasets: [{
                        label: 'Total Spent (₹)',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1 // Changed to 1 for bar charts
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Monthly Spending Trend',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Total Spent: ₹${context.parsed.y.toLocaleString('en-IN')}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount Spent (₹)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value.toLocaleString('en-IN');
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    }
                }
            });
        }

        function renderDailySpendingChart() {
            const ctx = document.getElementById('dailySpendingChart').getContext('2d');
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            const dailyData = {};
            
            currentExpenses
                .filter(expense => expense.date.startsWith(currentMonth))
                .forEach(expense => {
                    dailyData[expense.date] = (dailyData[expense.date] || 0) + expense.amount;
                });
            
            const sortedDates = Object.keys(dailyData).sort();
            const data = sortedDates.map(date => dailyData[date]);

            if (sortedDates.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Segoe UI';
                ctx.fillStyle = '#6c757d';
                ctx.textAlign = 'center';
                ctx.fillText('No spending data for the current month yet.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            charts.dailySpending = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates.map(date => new Date(date).getDate()),
                    datasets: [{
                        label: 'Daily Spending (₹)',
                        data: data,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 2, // Slightly thinner line
                        fill: true,
                        tension: 0.3 // Smoother curves
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Spending (Current Month)',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Spent: ₹${context.parsed.y.toLocaleString('en-IN')}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount Spent (₹)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value.toLocaleString('en-IN');
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Day of Month'
                            },
                            ticks: {
                                autoSkip: true,
                                maxTicksLimit: 15 // Limit number of ticks on x-axis
                            }
                        }
                    }
                }
            });
        }

        function renderWeeklyTrendChart() {
            const ctx = document.getElementById('weeklyTrendChart').getContext('2d');
            
            const weeklyData = {};
            currentExpenses.forEach(expense => {
                const date = new Date(expense.date + 'T00:00:00'); // Ensure date is parsed consistently
                const year = date.getFullYear();
                const week = getWeekNumber(date);
                const weekKey = `${year}-W${String(week).padStart(2, '0')}`; // Format: YYYY-WNN
                weeklyData[weekKey] = (weeklyData[weekKey] || 0) + expense.amount;
            });
            
            const sortedWeeks = Object.keys(weeklyData).sort();
            const data = sortedWeeks.map(week => weeklyData[week]);

            if (sortedWeeks.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Segoe UI';
                ctx.fillStyle = '#6c757d';
                ctx.textAlign = 'center';
                ctx.fillText('No spending data for weekly trend yet.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            charts.weeklyTrend = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedWeeks,
                    datasets: [{
                        label: 'Weekly Spending (₹)',
                        data: data,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Weekly Spending Trend',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Total Spent: ₹${context.parsed.y.toLocaleString('en-IN')}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount Spent (₹)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value.toLocaleString('en-IN');
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Week Number (YYYY-WNN)'
                            },
                            ticks: {
                                autoSkip: true,
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    }
                }
            });
        }

        function renderCategoryCountChart() {
            const ctx = document.getElementById('categoryCountChart').getContext('2d');
            
            const categoryCount = {};
            currentExpenses.forEach(expense => {
                categoryCount[expense.category] = (categoryCount[expense.category] || 0) + 1;
            });
            
            const labels = Object.keys(categoryCount);
            const data = Object.values(categoryCount);

            if (labels.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Segoe UI';
                ctx.fillStyle = '#6c757d';
                ctx.textAlign = 'center';
                ctx.fillText('No transaction data for categories yet.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            charts.categoryCount = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Transactions',
                        data: data,
                        backgroundColor: 'rgba(153, 102, 255, 0.8)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Number of Spends by Category',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Transactions'
                            },
                            ticks: {
                                stepSize: 1 // Ensure whole numbers for counts
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Category'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    }
                }
            });
        }

        function renderUserSpendingChart() {
            const ctx = document.getElementById('userSpendingChart').getContext('2d');
            
            const userSpending = {};
            currentExpenses.forEach(expense => {
                userSpending[expense.recordedBy] = (userSpending[expense.recordedBy] || 0) + expense.amount;
            });
            
            const labels = Object.keys(userSpending);
            const data = Object.values(userSpending);

            if (labels.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Segoe UI';
                ctx.fillStyle = '#6c757d';
                ctx.textAlign = 'center';
                ctx.fillText('No spending data by user yet.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            charts.userSpending = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Spending (₹)',
                        data: data,
                        backgroundColor: ['rgba(255, 159, 64, 0.8)', 'rgba(54, 162, 235, 0.8)'], // Distinct colors for users
                        borderColor: ['rgba(255, 159, 64, 1)', 'rgba(54, 162, 235, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Spending by User',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Total Spent: ₹${context.parsed.y.toLocaleString('en-IN')}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount Spent (₹)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value.toLocaleString('en-IN');
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'User'
                            }
                        }
                    }
                }
            });
        }

        function updateTopLists() {
            updateTopCategories();
            updateTopVendors();
        }

        function updateTopCategories() {
            const categoryTotals = {};
            currentExpenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });
            
            const sortedCategories = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3);
            
            const container = document.getElementById('topCategories');
            if (sortedCategories.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center;">No data available yet.</p>';
            } else {
                container.innerHTML = sortedCategories.map(([category, amount], index) => `
                    <div class="top-item">
                        <span>${index + 1}. ${category}</span>
                        <strong>₹${amount.toLocaleString('en-IN')}</strong>
                    </div>
                `).join('');
            }
        }

        function updateTopVendors() {
            const vendorTotals = {};
            currentExpenses.forEach(expense => {
                vendorTotals[expense.vendor] = (vendorTotals[expense.vendor] || 0) + expense.amount;
            });
            
            const sortedVendors = Object.entries(vendorTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3);
            
            const container = document.getElementById('topVendors');
            if (sortedVendors.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center;">No data available yet.</p>';
            } else {
                container.innerHTML = sortedVendors.map(([vendor, amount], index) => `
                    <div class="top-item">
                        <span>${index + 1}. ${vendor}</span>
                        <strong>₹${amount.toLocaleString('en-IN')}</strong>
                    </div>
                `).join('');
            }
        }

        // ==================== SEARCH & FILTER FUNCTIONS ====================
        function searchExpenses() {
            const searchText = document.getElementById('searchText').value.toLowerCase().trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            filteredExpenses = currentExpenses.filter(expense => {
                const matchesSearch = !searchText || 
                    expense.vendor.toLowerCase().includes(searchText) ||
                    expense.category.toLowerCase().includes(searchText) ||
                    (expense.note && expense.note.toLowerCase().includes(searchText)) || // Check if note exists
                    expense.recordedBy.toLowerCase().includes(searchText);
                
                const matchesStartDate = !startDate || expense.date >= startDate;
                const matchesEndDate = !endDate || expense.date <= endDate;
                
                return matchesSearch && matchesStartDate && matchesEndDate;
            });
            
            renderSearchResults();
        }

        function clearFilters() {
            document.getElementById('searchText').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            filteredExpenses = []; // Clear filtered expenses
            renderSearchResults(); // Re-render to show "Use filters" message
        }

        function renderSearchResults() {
            const tbody = document.querySelector('#searchResultsTable tbody');
            const messageEl = document.getElementById('searchMessage');
            
            if (filteredExpenses.length === 0 && (document.getElementById('searchText').value === '' && document.getElementById('startDate').value === '' && document.getElementById('endDate').value === '')) {
                // No filters applied, show initial info message
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #6c757d;">Use the search filters above to find specific expenses.</td></tr>';
                messageEl.style.display = 'block';
                messageEl.textContent = 'Use the search filters above to find specific expenses.';
                messageEl.className = 'message info';
            } else if (filteredExpenses.length === 0) {
                // Filters applied but no results
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #6c757d;">No expenses match your search criteria.</td></tr>';
                messageEl.style.display = 'block';
                messageEl.textContent = 'No expenses match your search criteria.';
                messageEl.className = 'message info';
            } else {
                tbody.innerHTML = filteredExpenses.map(expense => `
                    <tr>
                        <td data-label="Date">${formatDate(expense.date)}</td>
                        <td data-label="Recorded By">${expense.recordedBy}</td>
                        <td data-label="Category">${expense.category}</td>
                        <td data-label="Vendor">${expense.vendor}</td>
                        <td data-label="Amount">₹${expense.amount.toLocaleString('en-IN')}</td>
                        <td data-label="Note">${expense.note || '-'}</td>
                        <td data-label="Actions">
                            <button class="btn btn-danger btn-small" onclick="deleteExpense('${expense.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
                messageEl.style.display = 'none'; // Hide message if results are shown
            }
        }

        // ==================== EXPORT FUNCTIONS ====================
        function downloadCSV(expenses = currentExpenses, filename = 'expenses') {
            if (expenses.length === 0) {
                showMessage('No data to export', 'error');
                return;
            }
            
            const headers = ['Date', 'Recorded By', 'Category', 'Vendor', 'Amount', 'Note'];
            const csvContent = [
                headers.map(h => `"${h.replace(/"/g, '""')}"`).join(','), // Quote headers
                ...expenses.map(expense => [
                    `"${expense.date.replace(/"/g, '""')}"`,
                    `"${expense.recordedBy.replace(/"/g, '""')}"`,
                    `"${expense.category.replace(/"/g, '""')}"`,
                    `"${expense.vendor.replace(/"/g, '""')}"`,
                    expense.amount,
                    `"${(expense.note || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link); // Required for Firefox
            link.click();
            document.body.removeChild(link); // Clean up
            showMessage('✅ CSV downloaded successfully!', 'success');
        }

        function downloadPDF(expenses = currentExpenses, filename = 'expenses') {
            if (expenses.length === 0) {
                showMessage('No data to export', 'error');
                return;
            }
            
            // window.jsPDF is available thanks to the script include
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.text('Expense Report', 20, 20);
            
            // Add summary
            doc.setFontSize(12);
            const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            doc.text(`Total Expenses: ₹${total.toLocaleString('en-IN')}`, 20, 35);
            doc.text(`Number of Transactions: ${expenses.length}`, 20, 45);
            doc.text(`Generated on: ${new Date().toLocaleDateString('en-IN')}`, 20, 55);
            
            // Add table
            const tableData = expenses.map(expense => [
                formatDate(expense.date),
                expense.recordedBy,
                expense.category,
                expense.vendor,
                `₹${expense.amount.toLocaleString('en-IN')}`,
                expense.note || '-'
            ]);
            
            doc.autoTable({
                startY: 70,
                head: [['Date', 'Recorded By', 'Category', 'Vendor', 'Amount', 'Note']],
                body: tableData,
                styles: { fontSize: 9, cellPadding: 3, overflow: 'linebreak' },
                headStyles: { fillColor: [52, 152, 219], textColor: 255, fontStyle: 'bold' },
                columnStyles: { // Example column styling
                    0: { cellWidth: 20 }, // Date
                    1: { cellWidth: 25 }, // Recorded By
                    2: { cellWidth: 25 }, // Category
                    3: { cellWidth: 35 }, // Vendor
                    4: { cellWidth: 25, halign: 'right' }, // Amount
                    5: { cellWidth: 'auto' } // Note
                },
                margin: { horizontal: 10 }
            });
            
            doc.save(`${filename}_${new Date().toISOString().slice(0, 10)}.pdf`);
            showMessage('✅ PDF downloaded successfully!', 'success');
        }

        function downloadFilteredCSV() {
            downloadCSV(filteredExpenses, 'filtered_expenses');
        }

        function downloadFilteredPDF() {
            downloadPDF(filteredExpenses, 'filtered_expenses');
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showTab(tabName, event) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab and activate button
            document.getElementById(tabName).classList.add('active');
            // Ensure event.target is the button that was clicked
            if (event && event.target && event.target.classList.contains('tab-button')) {
                 event.target.classList.add('active');
            } else {
                // Fallback: if not triggered by click, find the button by tabName
                document.querySelector(`.tab-button[onclick*="${tabName}"]`).classList.add('active');
            }

            // Render charts if summary tab is selected
            if (tabName === 'summary') {
                setTimeout(() => {
                    renderCharts();
                    updateTopLists();
                }, 100); // Small delay to ensure tab content is visible and canvases are ready
            }
            
            // Reset search results/message when switching to search tab
            if (tabName === 'search') {
                document.getElementById('searchMessage').style.display = 'block';
                document.getElementById('searchMessage').textContent = 'Use the search filters above to find specific expenses.';
                document.getElementById('searchMessage').className = 'message info';
                document.querySelector('#searchResultsTable tbody').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #6c757d;">Use the search filters above to find specific expenses.</td></tr>'; // Clear table on tab switch
                // Clear search input fields as well
                document.getElementById('searchText').value = '';
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                filteredExpenses = []; // Reset filtered expenses when tab changes
            }
            // Always update display when changing tabs to ensure data is fresh
            updateDisplay();
        }

        // Function to display messages to the user
        function showMessage(message, type = 'info') {
            // Remove any existing messages to avoid clutter
            const existingMessage = document.querySelector('.message-container');
            if (existingMessage) {
                existingMessage.remove();
            }

            // Create a container for the message to easily manage its position
            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-container';
            messageContainer.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 1000;
                width: 90%;
                max-width: 400px;
                text-align: center;
                animation: slideIn 0.3s forwards;
            `;

            // Create message element
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = message;
            
            messageContainer.appendChild(messageEl);
            document.body.appendChild(messageContainer);

            // Add CSS animation keyframes dynamically if not already present
            if (!document.getElementById('slideInKeyframes')) {
                const styleSheet = document.createElement("style");
                styleSheet.type = "text/css";
                styleSheet.id = "slideInKeyframes";
                styleSheet.innerText = `
                    @keyframes slideIn {
                        from { opacity: 0; transform: translateX(-50%) translateY(-50px); }
                        to { opacity: 1; transform: translateX(-50%) translateY(0); }
                    }
                    @keyframes slideOut {
                        from { opacity: 1; transform: translateX(-50%) translateY(0); }
                        to { opacity: 0; transform: translateX(-50%) translateY(-50px); }
                    }
                `;
                document.head.appendChild(styleSheet);
            }

            // Automatically remove message after a few seconds
            setTimeout(() => {
                messageContainer.style.animation = 'slideOut 0.3s forwards';
                messageContainer.addEventListener('animationend', () => {
                    messageContainer.remove();
                });
            }, 3000); // Message disappears after 3 seconds
        }

        // Utility function to format date from YYYY-MM-DD to DD-MM-YYYY
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const [year, month, day] = dateString.split('-');
                return `${day}-${month}-${year}`;
            } catch (e) {
                console.error('Error formatting date:', e);
                return dateString; // Return original if formatting fails
            }
        }

        // Utility function to get week number (ISO week date system)
        // From https://weeknumber.net/how-to/javascript
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            // Set to nearest Thursday: current date + 4 - current day number
            // Make Sunday's day number 7
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            // Get first day of year
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            // Calculate full weeks to nearest Thursday
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }

        // Initial tab activation on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Ensure the dashboard tab is active by default on load
            showTab('dashboard', { target: document.querySelector('.tab-button.active') });
        });

    </script>
</body>
</html>
