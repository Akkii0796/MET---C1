<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Expense Tracker</title>
    <!-- Chart.js & Datalabels -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary: #3b82f6;
            --accent: #38bdf8;
            --danger: #ef4444;
            --success: #22c55e;
            --warn: #fbbf24;
            --bg: #f7fafc;
            --card-bg: #fff;
            --radius: 16px;
            --shadow: 0 2px 18px 0 rgba(52,93,182,0.06);
            --font-lg: 1.16rem;
            --font-base: 1.02rem;
            --font-sm: .98rem;
        }
        body {
            margin: 0;
            background: var(--bg);
            font-family: system-ui, 'Segoe UI', sans-serif;
            color: #212121;
        }
        .container {
            max-width: 420px;
            margin: 0 auto 60px auto;
            background: var(--card-bg);
            min-height: 100vh;
            box-shadow: var(--shadow);
            border-radius: 0 0 var(--radius) var(--radius);
        }
        .app-header {
            background: linear-gradient(92deg, var(--primary), var(--accent));
            color: #fff;
            border-radius: 0 0 var(--radius) var(--radius);
            padding: 1.13rem 1rem .85rem 1rem;
            box-shadow: 0 4px 28px rgba(59,130,246,0.09);
            text-align: center;
            font-size: var(--font-lg);
            font-weight: 700;
            letter-spacing: .2px;
            position: sticky;
            top: 0;
            z-index: 5;
            user-select: none;
        }
        .section-title {
            display: flex;
            align-items: center;
            gap: 9px;
            font-size: 1.09rem;
            font-weight: 600;
            color: var(--primary);
            margin: 0 0 11px 0;
        }
        .section-divider {
            height: 1px;
            border: 0;
            background: #e4eaf2;
            margin: 1.2rem 0 .7rem 0;
        }

        /* --- Sections --- */
        .section-card {
            background: #f1f5fa;
            border-radius: var(--radius);
            padding: 1.1rem 1.1rem .8rem 1.1rem;
            box-shadow: 0 2px 10px rgba(59,130,246,0.06);
            margin-bottom: 16px;
        }
        .section-card.dark {
            background: var(--card-bg);
        }
        .section-card + .section-card {
            margin-top: 0;
        }
        /* Budget summary row */
        .budget-summary {
            display: flex;
            gap: 7px;
            flex-wrap: wrap;
            margin-bottom: 14px;
        }
        .budget-card {
            flex: 1 1 0;
            background: linear-gradient(96deg, #6366f1 0%, #38bdf8 100%);
            color: #fff;
            border-radius: var(--radius);
            text-align: center;
            padding: .55rem .1rem;
            font-size: 1.01rem;
            box-shadow: 0 1.5px 8px rgba(59,130,246,0.07);
            min-width: 102px;
        }
        .budget-card .amount {
            font-size: 1.22rem;
            font-weight: 700;
            margin-top: .19rem;
            letter-spacing: 1.1px;
        }
        /* Progress bar */
        .progress-bar-wrap { margin: .35rem 0 .6rem 0;}
        .progress-bar {
            width: 100%; height: 14px;
            background: #e8edf2; border-radius: 9px; overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transition: width .6s cubic-bezier(.42,0,.58,1);
        }
        .progress-fill.warn { background: linear-gradient(90deg,var(--warn),#ffe066);}
        .progress-fill.danger { background: linear-gradient(90deg,#ef4444,#f87171);}
        .progress-text { font-size: var(--font-sm); margin-top: 2.5px; text-align: right; color:#2563eb;}

        /* Forms */
        .form-row { display: flex; gap: 8px; margin-bottom: .8rem; flex-wrap: wrap;}
        .form-group { margin-bottom: .55rem; flex: 1; min-width: 105px;}
        .form-group label { font-weight: 600; font-size: var(--font-sm); margin-bottom: 3px; display: block;}
        input, select, textarea {
            width: 100%;
            padding: 10px 7px;
            border-radius: 7px;
            border: 1.3px solid #d1d5db;
            font-size: var(--font-base);
            transition: border .2s;
            background: #fff;
        }
        input:focus, select:focus, textarea:focus {
            border: 1.7px solid var(--primary);
            outline: none;
        }
        .btn {
            padding: 9px 17px;
            border: none;
            border-radius: 7px;
            background: linear-gradient(90deg,var(--primary),var(--accent));
            color: #fff;
            font-size: var(--font-base);
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(59,130,246,0.10);
            margin-right: 5px;
            transition: background .18s, transform .17s;
        }
        .btn:active { transform: scale(0.97);}
        .btn.secondary { background: #e5e7eb; color: #2563eb;}
        .btn.danger { background: linear-gradient(90deg,#ef4444,#f87171);}
        .btn.success { background: linear-gradient(90deg,#22c55e,#16a34a);}
        .btn[disabled] { opacity: .64; cursor: not-allowed; }
        .btn.small { padding: 4px 9px; font-size: .96em;}
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 6px; }

        /* Expenses Table Compact */
        .table-container { overflow-x: auto; border-radius: var(--radius); background: var(--card-bg); box-shadow: 0 1.5px 10px rgba(0,0,0,0.03);}
        table { width: 100%; border-collapse: collapse; font-size: .98rem;}
        th, td { padding: 7px 4px; border-bottom: 1px solid #e5e7eb; text-align: left; }
        th { background: #f2f8fe; color: #374151; font-size: .98em; font-weight: 700;}
        td.amount { font-weight: bold; font-size: 1.07em; color: var(--primary);}
        td.note { max-width: 90px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        td.actions { min-width: 84px;}
        /* Mobile Table Tweaks */
        @media (max-width: 460px) {
            th, td { padding: 7px 2px;}
            .budget-card { font-size: .97rem; }
            .budget-card .amount { font-size: 1.09rem; }
        }
        .compact-row { font-size: .98em; height: 34px; }
        .compact-row td { padding: 7px 2px; }
        /* Checkbox sticky */
        th:first-child, td:first-child { position: sticky; left: 0; background: #fff; z-index: 1;}
        .expenses-table tr.selected { background: #e0e7ff; }
        .bulk-checkbox { width: 17px; height: 17px;}
        /* Pills */
        .user-pill { background: #e0e7ff; padding: 2px 10px; border-radius: 12px; font-size: .98em; margin-right: 3px;}
        /* Chart Section */
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 18px;
        }
        .chart-container { background: #f8fafc; border-radius: var(--radius); padding: .6rem .2rem .7rem .2rem; }
        .chart-container h4 { font-size: .99em; font-weight: 600; margin-bottom: 7px; color:#3b82f6; }
        @media (max-width: 700px) {
            .chart-grid { grid-template-columns: 1fr; gap: 12px;}
        }
        /* Top lists */
        .top-list {
            display: flex;
            gap: 10px;
            margin-bottom: .5rem;
        }
        .top-box {
            background: #fff5e1;
            border-radius: 11px;
            padding: 9px 13px;
            font-size: .98em;
            color: #c2410c;
            font-weight: 600;
            min-width: 96px;
            text-align: center;
            box-shadow: 0 2px 7px rgba(251,191,36,0.08);
        }
        .top-box.vendor {
            background: #e0f2fe; color: #2563eb;
        }
        /* --- Modal & Toast --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.18); z-index: 1001; display: flex; align-items: center; justify-content: center;
        }
        .modal {
            background: #fff; border-radius: var(--radius); padding: 1.11rem .9rem .9rem .9rem;
            box-shadow: 0 9px 36px rgba(59,130,246,0.14);
            max-width: 98vw; width: 325px; min-width: 0;
            position: relative;
            animation: fadeIn .16s;
        }
        .modal-header {
            font-weight: 600; font-size: 1.11em; margin-bottom: .4rem; display: flex; align-items: center; gap: 8px;
        }
        .modal-close {
            position: absolute; right: 12px; top: 8px; background: none; border: none; font-size: 1.26em; color: #9ca3af; cursor: pointer;
        }
        .modal-content { margin-bottom: .9rem;}
        .category-chip, .user-chip {
            display: inline-block; background: #e0e7ff; color: #374151; padding: 2px 10px; border-radius: 11px;
            font-size: .97em; margin: 2px 6px 2px 0;
        }
        .chip-remove { margin-left: 4px; color: var(--danger); cursor: pointer; font-size: 1.03em;}
        /* Toast */
        .toast {
            position: fixed; top: 19px; left: 50%; transform: translateX(-50%);
            min-width: 170px; max-width: 95vw; padding: 12px 18px; font-size: .99em;
            border-radius: var(--radius); z-index: 2002; color: #fff;
            box-shadow: 0 8px 32px rgba(59,130,246,0.12);
            animation: fadeIn .22s;
        }
        .toast.success { background: var(--success);}
        .toast.error { background: var(--danger);}
        .toast.info { background: var(--primary);}
        /* Bottom Tab Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 55px;
            background: #fff;
            box-shadow: 0 -2px 12px rgba(52,93,182,0.08);
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            justify-content: space-around;
            align-items: stretch;
            z-index: 50;
            user-select: none;
        }
        .nav-btn {
            flex: 1;
            border: none;
            background: none;
            color: #8ea1d5;
            font-size: 1.16em;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            cursor: pointer;
            transition: color .16s;
        }
        .nav-btn.active {
            color: var(--primary);
            font-weight: 700;
        }
        .nav-btn .material-icons {
            font-size: 1.44em;
        }
        .nav-label { font-size: .87em; margin-top: -1.5px;}
        @media (min-width: 701px) {
            .bottom-nav { max-width: 420px; left: 50%; transform: translateX(-50%); border-radius: 0 0 var(--radius) var(--radius);}
        }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header" id="appHeader">üí∞ Monthly Expense Tracker</div>
        <!-- DASHBOARD TAB -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="section-card">
                <div class="section-title"><span class="material-icons">account_balance_wallet</span> Monthly Budget</div>
                <div class="budget-summary">
                    <div class="budget-card">
                        <div>Total Budget</div>
                        <div class="amount" id="totalBudget">‚Çπ0</div>
                    </div>
                    <div class="budget-card">
                        <div>Total Spent</div>
                        <div class="amount" id="totalSpent">‚Çπ0</div>
                    </div>
                    <div class="budget-card">
                        <div>Remaining</div>
                        <div class="amount" id="remainingBudget">‚Çπ0</div>
                    </div>
                </div>
                <div class="progress-bar-wrap">
                    <div class="progress-bar">
                        <div class="progress-fill" id="budgetProgress"></div>
                    </div>
                    <div class="progress-text" id="progressText"></div>
                </div>
                <div class="form-row" style="margin-bottom:0;">
                    <input type="number" id="newBudget" placeholder="Set new monthly budget" min="0">
                    <button class="btn success" onclick="setBudget()">Set</button>
                    <button class="btn secondary" onclick="resetBudget()">Reset</button>
                </div>
            </div>
            <div class="section-card dark" style="margin-top:12px;">
                <div class="section-title"><span class="material-icons">add_circle</span> Add New Expense</div>
                <form id="expenseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>User</label>
                            <select id="expUser"></select>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="expCategory"></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Vendor</label>
                            <input type="text" id="expVendor" required placeholder="Enter vendor name">
                        </div>
                        <div class="form-group">
                            <label>Amount (‚Çπ)</label>
                            <input type="number" id="expAmount" required min="0" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="expDate" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Note (Optional)</label>
                        <textarea id="expNote" rows="2" placeholder="Add any additional notes..."></textarea>
                    </div>
                    <button type="submit" class="btn success" id="addExpenseBtn">Add Expense</button>
                </form>
            </div>
            <div class="section-divider"></div>
            <div class="section-card">
                <div class="section-title"><span class="material-icons">history</span> Recent Expenses</div>
                <div class="btn-group">
                    <button class="btn danger" onclick="deleteSelectedExpenses()">Delete Selected</button>
                    <button class="btn" onclick="downloadCSV()">Export CSV</button>
                    <button class="btn" onclick="downloadPDF()">Export PDF</button>
                    <span id="selectedCount" style="font-size:.97em;color:#666;"></span>
                </div>
                <div class="table-container">
                    <table id="recentExpensesTable" class="expenses-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" class="bulk-checkbox" onchange="toggleSelectAll(this)"></th>
                                <th>Date</th>
                                <th>User</th>
                                <th>Category</th>
                                <th>Vendor</th>
                                <th>‚Çπ</th>
                                <th>Note</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- SUMMARY TAB -->
        <div id="tab-summary" class="tab-content">
            <div class="section-card">
                <div class="section-title"><span class="material-icons">insights</span> Analytics & Insights</div>
                <div class="chart-grid">
                    <div class="chart-container">
                        <h4>By Category</h4>
                        <canvas id="categoryPieChart" height="170"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>Monthly Trend</h4>
                        <canvas id="monthlyTrendChart" height="170"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>Weekly Trend (This Month)</h4>
                        <canvas id="weeklyTrendChart" height="170"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>Daily Spend (This Month)</h4>
                        <canvas id="dailyLineChart" height="170"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>Cumulative Spend</h4>
                        <canvas id="cumulativeChart" height="170"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>By User</h4>
                        <canvas id="userSpendingChart" height="170"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>By Category (Frequency)</h4>
                        <canvas id="categoryCountChart" height="170"></canvas>
                    </div>
                </div>
                <div class="section-divider"></div>
                <div style="margin-bottom: .7rem; font-size:1.03em;">
                    <b>Top Categories</b>
                    <div class="top-list" id="topCategories"></div>
                </div>
                <div style="margin-bottom: .1rem; font-size:1.03em;">
                    <b>Top Vendors</b>
                    <div class="top-list" id="topVendors"></div>
                </div>
            </div>
        </div>
        <!-- SEARCH TAB -->
        <div id="tab-search" class="tab-content">
            <div class="section-card">
                <div class="section-title"><span class="material-icons">search</span> Search & Filter Expenses</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="searchText">Search</label>
                        <input type="text" id="searchText" placeholder="Search by vendor, category, note, or user...">
                    </div>
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate">
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="searchExpenses()">üîç Search</button>
                    <button class="btn secondary" onclick="clearFilters()">üîÑ Clear</button>
                    <button class="btn" onclick="downloadFilteredCSV()">Export CSV</button>
                    <button class="btn" onclick="downloadFilteredPDF()">Export PDF</button>
                </div>
                <div class="table-container">
                    <table id="searchResultsTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="searchSelectAll" class="bulk-checkbox" onchange="toggleSearchSelectAll(this)"></th>
                                <th>Date</th>
                                <th>User</th>
                                <th>Category</th>
                                <th>Vendor</th>
                                <th>‚Çπ</th>
                                <th>Note</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <span id="searchSelectedCount" style="font-size:.97em;color:#666;"></span>
            </div>
        </div>
        <!-- SETTINGS MODAL/TOAST MOUNT -->
        <div id="modalRoot"></div>
        <div id="toast"></div>
    </div>
    <!-- Bottom Tab Bar -->
    <nav class="bottom-nav">
        <button class="nav-btn active" id="nav-dashboard" onclick="showTab('dashboard')">
            <span class="material-icons">dashboard</span>
            <div class="nav-label">Dashboard</div>
        </button>
        <button class="nav-btn" id="nav-summary" onclick="showTab('summary')">
            <span class="material-icons">insights</span>
            <div class="nav-label">Summary</div>
        </button>
        <button class="nav-btn" id="nav-search" onclick="showTab('search')">
            <span class="material-icons">search</span>
            <div class="nav-label">Search</div>
        </button>
        <button class="nav-btn" id="nav-settings" onclick="openSettingsModal()">
            <span class="material-icons">settings</span>
            <div class="nav-label">Settings</div>
        </button>
    </nav>

<script>
    // --- App State ---
    const STORAGE = {
        EXPENSES: "exp_trk_expenses",
        BUDGET: "exp_trk_budget",
        CATEGORIES: "exp_trk_categories",
        USERS: "exp_trk_users"
    };
    const DEFAULT_CATEGORIES = [
        "Grocery", "Bills", "Travelling", "Food", "Medical", "EMI", "Investment",
        "Shopping", "Entertainment", "Personal Care", "Education", "Gifts/Donations",
        "Home Maintenance", "Transportation", "Utilities", "Others"
    ];
    const DEFAULT_USERS = ["Akshay", "Achal"];

    let expenses = [];
    let budget = 0;
    let categories = [];
    let users = [];
    let selectedExpenseIds = [];
    let selectedSearchIds = [];
    let editExpenseId = null;
    let filteredExpenses = [];

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', function() {
        setAppHeaderMonth();
        loadState();
        populateUserCat();
        renderBudget();
        renderExpensesTable();
        renderCharts();
        renderTopLists();
        document.getElementById('expenseForm').addEventListener('submit', handleExpenseSubmission);
        document.getElementById('expDate').valueAsDate = new Date();
        // Tab sync for reload
        if(location.hash) showTab(location.hash.replace('#tab-',''));
    });

    // --- Dynamic Header with Month ---
    function setAppHeaderMonth() {
        const mon = new Date();
        const mStr = mon.toLocaleString('en-US', { month: 'long' });
        const y = mon.getFullYear();
        document.getElementById('appHeader').textContent =
            `üí∞ Monthly Expense Tracker ‚Äì ${mStr} ${y}`;
    }

    // --- Tabs (Top + Bottom) ---
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.getElementById('tab-'+tabName).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('nav-'+tabName).classList.add('active');
        if(tabName === 'summary') { renderCharts(); renderTopLists();}
        if(tabName === 'dashboard') renderExpensesTable();
        history.replaceState(null, '', '#tab-'+tabName);
    }

    // --- State Management ---
    function saveState() {
        localStorage.setItem(STORAGE.EXPENSES, JSON.stringify(expenses));
        localStorage.setItem(STORAGE.BUDGET, JSON.stringify(budget));
        localStorage.setItem(STORAGE.CATEGORIES, JSON.stringify(categories));
        localStorage.setItem(STORAGE.USERS, JSON.stringify(users));
    }
    function loadState() {
        try { expenses = JSON.parse(localStorage.getItem(STORAGE.EXPENSES)) || []; } catch { expenses = []; }
        try { budget = JSON.parse(localStorage.getItem(STORAGE.BUDGET)) || 0; } catch { budget = 0; }
        try { categories = JSON.parse(localStorage.getItem(STORAGE.CATEGORIES)) || DEFAULT_CATEGORIES.slice(); } catch { categories = DEFAULT_CATEGORIES.slice(); }
        try { users = JSON.parse(localStorage.getItem(STORAGE.USERS)) || DEFAULT_USERS.slice(); } catch { users = DEFAULT_USERS.slice(); }
    }

    // --- Budget Section ---
    function renderBudget() {
        document.getElementById('totalBudget').textContent = "‚Çπ" + budget.toLocaleString("en-IN");
        const currentMonth = new Date().toISOString().slice(0,7);
        const spent = expenses.filter(e=>e.date.startsWith(currentMonth)).reduce((t,e)=>t+Number(e.amount),0);
        document.getElementById('totalSpent').textContent = "‚Çπ" + spent.toLocaleString("en-IN");
        document.getElementById('remainingBudget').textContent = "‚Çπ" + (budget-spent).toLocaleString("en-IN");
        // Progress bar
        const percent = budget ? Math.min(100, (spent/budget)*100) : 0;
        const pf = document.getElementById('budgetProgress');
        pf.style.width = percent+"%";
        pf.className = 'progress-fill';
        if(percent >= 90) pf.classList.add('danger');
        else if(percent >= 70) pf.classList.add('warn');
        document.getElementById('progressText').textContent = `Used: ${percent.toFixed(1)}%`;
    }
    function setBudget() {
        let val = parseFloat(document.getElementById('newBudget').value);
        if(isNaN(val) || val<0) { showToast("Invalid budget", "error"); return;}
        budget = val;
        saveState(); renderBudget();
        document.getElementById('newBudget').value = "";
        showToast("Budget updated!","success");
    }
    function resetBudget() {
        if(!confirm("Reset budget to zero?")) return;
        budget = 0;
        saveState(); renderBudget();
        showToast("Budget reset.","success");
    }

    // --- Add/Edit Expense ---
    function handleExpenseSubmission(e) {
        e.preventDefault();
        let user = document.getElementById('expUser').value;
        let cat = document.getElementById('expCategory').value;
        let vend = document.getElementById('expVendor').value.trim();
        let amt = parseFloat(document.getElementById('expAmount').value);
        let date = document.getElementById('expDate').value;
        let note = document.getElementById('expNote').value.trim();
        if(!user||!cat||!vend||isNaN(amt)||amt<=0||!date) {
            showToast("Fill all fields correctly","error"); return;
        }
        expenses.push({
            id: (Date.now()+Math.random()).toString(36),
            recordedBy: user,
            category: cat,
            vendor: vend,
            amount: amt,
            date, note,
            timestamp: Date.now()
        });
        saveState();
        e.target.reset();
        document.getElementById('expDate').valueAsDate = new Date();
        showToast("Expense added!","success");
        renderExpensesTable(); renderBudget(); renderCharts(); renderTopLists();
    }
    function openEditExpenseModal(id) {
        const e = expenses.find(exp=>exp.id===id);
        if(!e) return;
        editExpenseId = id;
        showEditExpenseModal(e);
    }
    function showEditExpenseModal(e) {
        document.getElementById('modalRoot').innerHTML = `
            <div class="modal-backdrop">
                <div class="modal">
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                    <div class="modal-header">Edit Expense</div>
                    <div class="modal-content">
                        <div class="form-group"><label>User</label>
                            <select id="editUser">${users.map(u=>`<option${e.recordedBy===u?" selected":""}>${u}</option>`)}</select>
                        </div>
                        <div class="form-group"><label>Category</label>
                            <select id="editCategory">${categories.map(c=>`<option${e.category===c?" selected":""}>${c}</option>`)}</select>
                        </div>
                        <div class="form-group"><label>Vendor</label>
                            <input type="text" id="editVendor" value="${e.vendor}">
                        </div>
                        <div class="form-group"><label>Amount (‚Çπ)</label>
                            <input type="number" id="editAmount" value="${e.amount}">
                        </div>
                        <div class="form-group"><label>Date</label>
                            <input type="date" id="editDate" value="${e.date}">
                        </div>
                        <div class="form-group"><label>Note</label>
                            <textarea id="editNote" rows="2">${e.note||""}</textarea>
                        </div>
                    </div>
                    <button class="btn success" onclick="saveEditExpense()">Save</button>
                </div>
            </div>`;
    }
    function saveEditExpense() {
        let user = document.getElementById('editUser').value;
        let cat = document.getElementById('editCategory').value;
        let vend = document.getElementById('editVendor').value.trim();
        let amt = parseFloat(document.getElementById('editAmount').value);
        let date = document.getElementById('editDate').value;
        let note = document.getElementById('editNote').value.trim();
        if(!user||!cat||!vend||isNaN(amt)||amt<=0||!date) {
            showToast("Fill all fields correctly","error"); return;
        }
        let ix = expenses.findIndex(e=>e.id===editExpenseId);
        if(ix!==-1) {
            expenses[ix]={...expenses[ix],recordedBy:user,category:cat,vendor:vend,amount:amt,date,note};
            saveState(); renderExpensesTable(); renderBudget(); renderCharts(); renderTopLists();
            showToast("Expense updated","success");
        }
        closeModal();
    }
    function closeModal() { document.getElementById('modalRoot').innerHTML = ""; }

    // --- Expenses Table ---
    function renderExpensesTable() {
        selectedExpenseIds = [];
        let tbody = document.querySelector("#recentExpensesTable tbody");
        let rows = expenses.slice().sort((a,b)=>b.timestamp-a.timestamp).map(e=>compactExpenseRow(e)).join('');
        if(!rows) rows = `<tr><td colspan="8" style="text-align:center;color:#b91c1c;padding:17px;">No expenses yet.</td></tr>`;
        tbody.innerHTML = rows;
        updateSelectedCount();
    }
    function compactExpenseRow(e) {
        return `
            <tr data-id="${e.id}" class="compact-row${selectedExpenseIds.includes(e.id)?" selected":""}">
                <td><input type="checkbox" class="bulk-checkbox" onchange="selectExpense('${e.id}',this)" ${selectedExpenseIds.includes(e.id)?"checked":""}></td>
                <td>${formatDate(e.date)}</td>
                <td><span class="user-pill">${e.recordedBy}</span></td>
                <td>${e.category}</td>
                <td>${e.vendor}</td>
                <td class="amount">‚Çπ${(+e.amount).toLocaleString("en-IN")}</td>
                <td class="note" title="${e.note||""}">${e.note||""}</td>
                <td class="actions">
                    <button class="btn small" onclick="openEditExpenseModal('${e.id}')">Edit</button>
                    <button class="btn small danger" onclick="deleteExpense('${e.id}')">Delete</button>
                </td>
            </tr>`;
    }
    function deleteExpense(id) {
        if(!confirm("Delete this expense?")) return;
        expenses = expenses.filter(e=>e.id!==id);
        saveState();
        renderExpensesTable(); renderBudget(); renderCharts(); renderTopLists();
        showToast("Deleted.","success");
    }
    function selectExpense(id, cb) {
        if(cb.checked) selectedExpenseIds.push(id);
        else selectedExpenseIds = selectedExpenseIds.filter(x=>x!==id);
        updateSelectedCount();
    }
    function toggleSelectAll(cb) {
        if(cb.checked) {
            selectedExpenseIds = expenses.map(e=>e.id);
        } else {
            selectedExpenseIds = [];
        }
        renderExpensesTable();
        document.getElementById('selectAll').checked = cb.checked;
    }
    function updateSelectedCount() {
        document.getElementById('selectedCount').textContent =
            selectedExpenseIds.length ? selectedExpenseIds.length+" selected" : "";
        let all = document.getElementById('selectAll');
        if(all) all.checked = selectedExpenseIds.length === expenses.length && expenses.length>0;
    }
    function deleteSelectedExpenses() {
        if(selectedExpenseIds.length===0) { showToast("Select expenses first","info"); return;}
        if(!confirm("Delete "+selectedExpenseIds.length+" selected expenses?")) return;
        expenses = expenses.filter(e=>!selectedExpenseIds.includes(e.id));
        saveState(); renderExpensesTable(); renderBudget(); renderCharts(); renderTopLists();
        showToast("Bulk delete done","success");
    }

    // --- CSV/PDF Export (Dashboard) ---
    function downloadCSV() {
        if(!expenses.length) { showToast("No data to export","info"); return; }
        let csv = "Date,User,Category,Vendor,Amount,Note\n"+
            expenses.map(e=>[
                `"${e.date}"`,
                `"${e.recordedBy}"`,
                `"${e.category}"`,
                `"${e.vendor}"`,
                e.amount,
                `"${(e.note||"").replace(/"/g,'""')}"`
            ].join(",")).join("\n");
        let blob = new Blob([csv], { type: 'text/csv' });
        let url = URL.createObjectURL(blob);
        let a = document.createElement("a");
        a.href = url; a.download = "expenses_"+(new Date().toISOString().slice(0,10))+".csv";
        document.body.appendChild(a); a.click(); a.remove();
    }
    function downloadPDF() {
        if(!expenses.length) { showToast("No data to export","info"); return; }
        const { jsPDF } = window.jspdf;
        let doc = new jsPDF();
        doc.setFontSize(18); doc.text("Expense Report", 15, 18);
        doc.setFontSize(12);
        doc.text(`Total Expenses: ‚Çπ${expenses.reduce((s,e)=>s+Number(e.amount),0).toLocaleString("en-IN")}`,15,28);
        doc.text(`Generated: ${(new Date()).toLocaleDateString("en-IN")}`, 15, 34);
        doc.autoTable({
            head: [["Date","User","Category","Vendor","Amount","Note"]],
            body: expenses.map(e=>[formatDate(e.date),e.recordedBy,e.category,e.vendor,"‚Çπ"+(+e.amount).toLocaleString("en-IN"),e.note||""]),
            startY: 40,
            styles: { fontSize: 10 },
            columnStyles: {0:{cellWidth:18},4:{halign:'right'}}
        });
        doc.save("expenses_"+(new Date().toISOString().slice(0,10))+".pdf");
    }

    // --- Analytics & Charts ---
    let chartInstances = {};
    function renderCharts() {
        Object.values(chartInstances).forEach(c=>{try{c.destroy();}catch{}});
        // Pie: By Category
        let catAgg = {}, catCount = {};
        expenses.forEach(e=>{
            catAgg[e.category]= (catAgg[e.category]||0) + Number(e.amount);
            catCount[e.category]=(catCount[e.category]||0)+1;
        });
        let cats = Object.keys(catAgg), catVals = Object.values(catAgg);
        chartInstances.catPie = new Chart(document.getElementById('categoryPieChart').getContext('2d'), {
            type:'pie', data:{
                labels: cats, datasets: [{data: catVals, backgroundColor: genColors(cats.length)}]
            },
            options:{
                plugins:{legend:{position:'bottom'}, datalabels:{
                    color:'#fff', font:{weight:'bold'}, formatter:(v,ctx)=>{
                        let s = ctx.dataset.data.reduce((a,b)=>a+b,0);
                        let p = (v/s*100).toFixed(1); return p>7?p+"%":"";
                    }
                }}
            }, plugins:[ChartDataLabels]
        });
        // Monthly Trend
        let monAgg = {};
        expenses.forEach(e=>{
            let m = e.date.slice(0,7); monAgg[m]= (monAgg[m]||0)+Number(e.amount);
        });
        let mons = Object.keys(monAgg).sort(), monVals = mons.map(m=>monAgg[m]);
        chartInstances.monBar = new Chart(document.getElementById('monthlyTrendChart').getContext('2d'),{
            type:'bar', data:{
                labels: mons.map(m=>m.replace("-","/")), datasets:[{label:"Spent (‚Çπ)",data:monVals,backgroundColor:genColors(mons.length)}]
            },
            options:{
                plugins:{legend:{display:false},datalabels:{anchor:'end',align:'end',font:{weight:700}}},
                scales:{y:{beginAtZero:true}},
            }, plugins:[ChartDataLabels]
        });
        // Weekly Trend (current month)
        let currMon = new Date().toISOString().slice(0,7);
        let weekly = [0,0,0,0,0,0];
        expenses.filter(e=>e.date.startsWith(currMon)).forEach(e=>{
            let day = parseInt(e.date.slice(8,10));
            let week = Math.min(5, Math.floor((day-1)/7));
            weekly[week] += Number(e.amount);
        });
        chartInstances.weekBar = new Chart(document.getElementById('weeklyTrendChart').getContext('2d'),{
            type:'bar', data:{
                labels: ["W1","W2","W3","W4","W5","W6"],
                datasets:[{label:"Spent (‚Çπ)",data:weekly,backgroundColor:genColors(6)}]
            },
            options:{
                plugins:{legend:{display:false},datalabels:{anchor:'end',align:'end',font:{weight:700}}},
                scales:{y:{beginAtZero:true}},
            }, plugins:[ChartDataLabels]
        });
        // Daily Line (this month)
        let daysInMon = new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).getDate();
        let dayLine = Array(daysInMon).fill(0);
        expenses.filter(e=>e.date.startsWith(currMon)).forEach(e=>{
            let day = parseInt(e.date.slice(8,10))-1;
            if(dayLine[day]!==undefined) dayLine[day]+=Number(e.amount);
        });
        chartInstances.dailyLine = new Chart(document.getElementById('dailyLineChart').getContext('2d'),{
            type:'line', data:{
                labels: Array.from({length:daysInMon},(_,i)=>i+1),
                datasets:[{label:"‚Çπ/Day",data:dayLine,fill:true,tension:0.23,backgroundColor:'rgba(59,130,246,0.09)',borderColor:'#38bdf8'}]
            },
            options:{
                plugins:{legend:{display:false},datalabels:{display:false}},
                scales:{y:{beginAtZero:true}}
            }
        });
        // Cumulative Spend
        let cumu = [];
        let sum = 0;
        for(let d=0;d<daysInMon;d++) {
            sum += dayLine[d];
            cumu[d]=sum;
        }
        chartInstances.cumuLine = new Chart(document.getElementById('cumulativeChart').getContext('2d'),{
            type:'line', data:{
                labels: Array.from({length:daysInMon},(_,i)=>i+1),
                datasets:[{label:"Cumulative",data:cumu,fill:true,tension:0.23,backgroundColor:'rgba(56,189,248,0.09)',borderColor:'#3b82f6'}]
            },
            options:{
                plugins:{legend:{display:false},datalabels:{display:false}},
                scales:{y:{beginAtZero:true}}
            }
        });
        // User Spend
        let userAgg = {};
        expenses.forEach(e=>{userAgg[e.recordedBy]=(userAgg[e.recordedBy]||0)+Number(e.amount);});
        let us = Object.keys(userAgg), usVals = Object.values(userAgg);
        chartInstances.userBar = new Chart(document.getElementById('userSpendingChart').getContext('2d'),{
            type:'bar', data:{
                labels:us, datasets:[{label:"Spent (‚Çπ)",data:usVals,backgroundColor:genColors(us.length)}]
            },
            options:{
                plugins:{legend:{display:false},datalabels:{anchor:'end',align:'end',font:{weight:700}}},
                scales:{y:{beginAtZero:true}}
            }, plugins:[ChartDataLabels]
        });
        // Category Frequency
        let ccats = Object.keys(catCount), ccVals = Object.values(catCount);
        chartInstances.catCount = new Chart(document.getElementById('categoryCountChart').getContext('2d'),{
            type:'bar', data:{
                labels:ccats, datasets:[{label:"Transactions",data:ccVals,backgroundColor:genColors(ccats.length)}]
            }, options:{
                plugins:{legend:{display:false},datalabels:{anchor:'end',align:'end',font:{weight:700}}},
                scales:{y:{beginAtZero:true,stepSize:1}}
            }, plugins:[ChartDataLabels]
        });
    }
    function genColors(n) {
        const palette = [
            "#3b82f6","#6366f1","#f472b6","#ef4444","#10b981","#fbbf24","#38bdf8","#eab308",
            "#f59e42","#db2777","#14b8a6","#f87171","#a3e635","#e0f2fe","#818cf8"
        ];
        return Array.from({length:n},(_,i)=>palette[i%palette.length]);
    }
    // --- Top 3 Categories & Vendors ---
    function renderTopLists() {
        // Categories
        let catAgg = {};
        expenses.forEach(e=>{catAgg[e.category]= (catAgg[e.category]||0) + Number(e.amount);});
        let catArr = Object.entries(catAgg).sort((a,b)=>b[1]-a[1]).slice(0,3);
        document.getElementById('topCategories').innerHTML = catArr.length ?
            catArr.map(([cat,amt])=>`<div class="top-box">${cat}<br>‚Çπ${amt.toLocaleString("en-IN")}</div>`).join('') :
            `<div style="color:#c026d3">No data</div>`;
        // Vendors
        let vendAgg = {};
        expenses.forEach(e=>{vendAgg[e.vendor]= (vendAgg[e.vendor]||0) + Number(e.amount);});
        let vendArr = Object.entries(vendAgg).sort((a,b)=>b[1]-a[1]).slice(0,3);
        document.getElementById('topVendors').innerHTML = vendArr.length ?
            vendArr.map(([vend,amt])=>`<div class="top-box vendor">${vend}<br>‚Çπ${amt.toLocaleString("en-IN")}</div>`).join('') :
            `<div style="color:#2563eb">No data</div>`;
    }

    // --- Search & Filter ---
    function searchExpenses() {
        const searchText = document.getElementById('searchText').value.toLowerCase().trim();
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        filteredExpenses = expenses.filter(expense => {
            const matchesSearch = !searchText ||
                expense.vendor.toLowerCase().includes(searchText) ||
                expense.category.toLowerCase().includes(searchText) ||
                (expense.note && expense.note.toLowerCase().includes(searchText)) ||
                expense.recordedBy.toLowerCase().includes(searchText);
            const matchesStartDate = !startDate || expense.date >= startDate;
            const matchesEndDate = !endDate || expense.date <= endDate;
            return matchesSearch && matchesStartDate && matchesEndDate;
        });
        renderSearchResults();
    }
    function clearFilters() {
        document.getElementById('searchText').value = '';
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        filteredExpenses = [];
        renderSearchResults();
    }
    function renderSearchResults() {
        selectedSearchIds = [];
        let tbody = document.querySelector("#searchResultsTable tbody");
        let arr = filteredExpenses.length ? filteredExpenses : [];
        let rows = arr.length ? arr.map(e=>`
            <tr>
                <td><input type="checkbox" class="bulk-checkbox" onchange="selectSearchExpense('${e.id}',this)" ${selectedSearchIds.includes(e.id)?"checked":""}></td>
                <td>${formatDate(e.date)}</td>
                <td><span class="user-pill">${e.recordedBy}</span></td>
                <td>${e.category}</td>
                <td>${e.vendor}</td>
                <td class="amount">‚Çπ${(+e.amount).toLocaleString("en-IN")}</td>
                <td class="note" title="${e.note||""}">${e.note||""}</td>
                <td>
                    <button class="btn small" onclick="openEditExpenseModal('${e.id}')">Edit</button>
                    <button class="btn small danger" onclick="deleteExpense('${e.id}')">Delete</button>
                </td>
            </tr>
        `).join('') : `<tr><td colspan="8" style="text-align:center;color:#999;padding:17px;">No results</td></tr>`;
        tbody.innerHTML = rows;
        updateSearchSelectedCount();
    }
    function selectSearchExpense(id, cb) {
        if(cb.checked) selectedSearchIds.push(id);
        else selectedSearchIds = selectedSearchIds.filter(x=>x!==id);
        updateSearchSelectedCount();
    }
    function toggleSearchSelectAll(cb) {
        if(cb.checked && filteredExpenses.length) {
            selectedSearchIds = filteredExpenses.map(e=>e.id);
        } else {
            selectedSearchIds = [];
        }
        renderSearchResults();
        document.getElementById('searchSelectAll').checked = cb.checked;
    }
    function updateSearchSelectedCount() {
        document.getElementById('searchSelectedCount').textContent =
            selectedSearchIds.length ? selectedSearchIds.length+" selected" : "";
        let all = document.getElementById('searchSelectAll');
        if(all && filteredExpenses.length)
            all.checked = selectedSearchIds.length === filteredExpenses.length && filteredExpenses.length>0;
    }
    function downloadFilteredCSV() {
        let arr = filteredExpenses.length ? filteredExpenses : [];
        if(!arr.length) { showToast("No data to export","info"); return; }
        let csv = "Date,User,Category,Vendor,Amount,Note\n"+
            arr.map(e=>[
                `"${e.date}"`,
                `"${e.recordedBy}"`,
                `"${e.category}"`,
                `"${e.vendor}"`,
                e.amount,
                `"${(e.note||"").replace(/"/g,'""')}"`
            ].join(",")).join("\n");
        let blob = new Blob([csv], { type: 'text/csv' });
        let url = URL.createObjectURL(blob);
        let a = document.createElement("a");
        a.href = url; a.download = "filtered_expenses_"+(new Date().toISOString().slice(0,10))+".csv";
        document.body.appendChild(a); a.click(); a.remove();
    }
    function downloadFilteredPDF() {
        let arr = filteredExpenses.length ? filteredExpenses : [];
        if(!arr.length) { showToast("No data to export","info"); return; }
        const { jsPDF } = window.jspdf;
        let doc = new jsPDF();
        doc.setFontSize(18); doc.text("Filtered Expenses", 15, 18);
        doc.setFontSize(12);
        doc.text(`Total: ‚Çπ${arr.reduce((s,e)=>s+Number(e.amount),0).toLocaleString("en-IN")}`,15,28);
        doc.text(`Generated: ${(new Date()).toLocaleDateString("en-IN")}`, 15, 34);
        doc.autoTable({
            head: [["Date","User","Category","Vendor","Amount","Note"]],
            body: arr.map(e=>[formatDate(e.date),e.recordedBy,e.category,e.vendor,"‚Çπ"+(+e.amount).toLocaleString("en-IN"),e.note||""]),
            startY: 40,
            styles: { fontSize: 10 },
            columnStyles: {0:{cellWidth:18},4:{halign:'right'}}
        });
        doc.save("filtered_expenses_"+(new Date().toISOString().slice(0,10))+".pdf");
    }

    // --- Settings: Categories/Users ---
    function populateUserCat() {
        const userSel = document.getElementById('expUser');
        userSel.innerHTML = users.map(u=>`<option>${u}</option>`).join('');
        const catSel = document.getElementById('expCategory');
        catSel.innerHTML = categories.map(c=>`<option>${c}</option>`).join('');
    }
    function openSettingsModal() {
        document.getElementById('modalRoot').innerHTML = `
            <div class="modal-backdrop">
                <div class="modal">
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                    <div class="modal-header">Manage Categories & Users</div>
                    <div class="modal-content">
                        <div><b>Categories:</b><br>
                            ${categories.map((cat,i)=>`
                                <span class="category-chip">${cat} <span class="chip-remove" onclick="removeCategory(${i})">&times;</span></span>
                            `).join('')}
                        </div>
                        <div class="form-row">
                            <input id="catAddInput" placeholder="Add new category..." onkeydown="if(event.key==='Enter'){addCategory()}">
                            <button class="btn small" onclick="addCategory()">Add</button>
                        </div>
                        <hr style="margin:10px 0;">
                        <div><b>Users:</b><br>
                            ${users.map((u,i)=>`
                                <span class="user-chip">${u} <span class="chip-remove" onclick="removeUser(${i})">&times;</span></span>
                            `).join('')}
                        </div>
                        <div class="form-row">
                            <input id="userAddInput" placeholder="Add new user..." onkeydown="if(event.key==='Enter'){addUser()}">
                            <button class="btn small" onclick="addUser()">Add</button>
                        </div>
                    </div>
                </div>
            </div>`;
    }
    function addCategory() {
        let inp = document.getElementById('catAddInput');
        let val = (inp.value||"").trim();
        if(!val) return;
        if(categories.includes(val)) { showToast("Exists","info"); return;}
        categories.push(val);
        saveState(); closeModal(); openSettingsModal(); populateUserCat();
    }
    function removeCategory(i) {
        if(categories.length<=1) { showToast("Need at least one","info"); return;}
        if(!confirm("Delete category?")) return;
        let cat = categories[i];
        expenses = expenses.filter(e=>e.category!==cat);
        categories.splice(i,1);
        saveState(); closeModal(); openSettingsModal(); renderExpensesTable(); renderCharts(); renderTopLists(); populateUserCat();
    }
    function addUser() {
        let inp = document.getElementById('userAddInput');
        let val = (inp.value||"").trim();
        if(!val) return;
        if(users.includes(val)) { showToast("Exists","info"); return;}
        users.push(val);
        saveState(); closeModal(); openSettingsModal(); populateUserCat();
    }
    function removeUser(i) {
        if(users.length<=1) { showToast("Need at least one","info"); return;}
        if(!confirm("Delete user?")) return;
        let user = users[i];
        expenses = expenses.filter(e=>e.recordedBy!==user);
        users.splice(i,1);
        saveState(); closeModal(); openSettingsModal(); renderExpensesTable(); renderCharts(); renderTopLists(); populateUserCat();
    }

    // --- Toast/Message ---
    function showToast(msg, type="success") {
        let t = document.getElementById('toast');
        t.innerHTML = `<div class="toast ${type}">${msg}</div>`;
        setTimeout(()=>{t.innerHTML='';},1900);
    }
    // --- Date Utility ---
    function formatDate(str) {
        if(!str) return "";
        let [y,m,d]=str.split('-');
        return [d,m,y].join('-');
    }
</script>
</body>
</html>
