<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker Pro (Mobile Optimized)</title>
    <!-- Chart.js & Datalabels -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Icons (Material Icons) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --accent: #06b6d4;
            --danger: #ef4444;
            --success: #22c55e;
            --grey-bg: #f6f7fb;
            --grey: #6b7280;
            --radius: 14px;
            --font-large: 1.2rem;
            --font-medium: 1rem;
            --font-small: .95rem;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background: var(--grey-bg);
            color: #18181b;
        }
        .app-header {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            color: #fff;
            padding: 1rem .5rem;
            text-align: center;
            font-size: var(--font-large);
            font-weight: 600;
            letter-spacing: 1px;
            border-radius: 0 0 var(--radius) var(--radius);
        }
        .tabs {
            display: flex;
            justify-content: space-around;
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            position: sticky;
            top: 0;
            z-index: 3;
        }
        .tab {
            flex: 1;
            padding: .7rem 0;
            font-size: var(--font-medium);
            color: var(--grey);
            border: none;
            background: none;
            outline: none;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: #f0f9ff;
        }
        .tab i {
            vertical-align: middle;
            margin-right: .2rem;
        }
        .tab-content {
            display: none;
            animation: fadeIn .3s;
            padding: .7rem .5rem 1.2rem .5rem;
        }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        /* Budget Summary */
        .budget-grid {
            display: flex;
            gap: 8px;
            justify-content: space-between;
            margin: .7rem 0 1.2rem 0;
        }
        .budget-card {
            flex: 1;
            background: linear-gradient(135deg, #818cf8 0%, #06b6d4 100%);
            color: #fff;
            border-radius: var(--radius);
            text-align: center;
            padding: .7rem .1rem;
            font-size: 1.09rem;
            box-shadow: 0 2px 8px rgba(59,130,246,0.08);
        }
        .budget-card .amount {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: .3rem;
            letter-spacing: 1px;
        }
        .progress-bar-wrap { margin: .7rem 0; }
        .progress-bar {
            width: 100%; height: 18px;
            background: #e5e7eb; border-radius: 9px; overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transition: width .6s cubic-bezier(.42,0,.58,1);
        }
        .progress-fill.warning { background: linear-gradient(90deg,#fde047,#fbbf24);}
        .progress-fill.danger { background: linear-gradient(90deg,#ef4444,#f87171);}
        .progress-text { font-size: var(--font-small); margin-top: 3px; text-align: right;}

        /* Form & Controls */
        .form-row { display: flex; gap: 8px; margin-bottom: .7rem;}
        .form-row .form-group { flex: 1; }
        .form-group { margin-bottom: .6rem;}
        .form-group label { font-weight: 600; font-size: var(--font-small); margin-bottom: 2px; display: block;}
        input, select, textarea {
            width: 100%;
            padding: 10px 7px;
            border-radius: 7px;
            border: 1.5px solid #d1d5db;
            font-size: var(--font-medium);
            transition: border .2s;
        }
        input:focus, select:focus, textarea:focus {
            border: 1.7px solid var(--primary);
            outline: none;
        }
        .radio-group { display: flex; gap: 7px; }
        .user-pill { background: #e0e7ff; padding: 2px 10px; border-radius: 12px; font-size: .98em; margin-right: 4px;}
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 7px;
            background: linear-gradient(90deg,var(--primary),var(--accent));
            color: #fff;
            font-size: var(--font-medium);
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(59,130,246,0.09);
            margin-right: 6px;
            transition: background .2s, transform .2s;
        }
        .btn:active { transform: scale(0.97);}
        .btn.secondary { background: #e5e7eb; color: #374151;}
        .btn.danger { background: linear-gradient(90deg,#ef4444,#f87171);}
        .btn.success { background: linear-gradient(90deg,#22c55e,#16a34a);}
        .btn[disabled] { opacity: .65; cursor: not-allowed; }
        .btn.small { padding: 7px 12px; font-size: .92rem;}

        /* Expenses Table Compact */
        .expenses-table-wrap {
            overflow-x: auto;
            margin: .7rem 0;
            border-radius: var(--radius);
            background: #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        }
        table.expenses-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-medium);
        }
        .expenses-table th, .expenses-table td {
            padding: 6px 5px;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
        }
        .expenses-table th {
            background: #f0f9ff;
            color: #374151;
            font-size: 1.02em;
        }
        .expenses-table tr.selected { background: #e0e7ff; }
        .expenses-table td.amount { font-weight: bold; font-size: 1.15em; color: var(--primary-dark);}
        .expenses-table td.note { max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .expenses-table td.actions { min-width: 90px;}
        .edit-row input, .edit-row select, .edit-row textarea { padding: 6px 3px; font-size: .95em;}
        .edit-row td { background: #f3f4f6 !important;}
        .compact-row { font-size: 1.09em; height: 40px; }
        .compact-row td { padding: 6px 4px; }

        /* Checkbox for bulk actions */
        .bulk-checkbox { width: 18px; height: 18px;}

        /* Floating Action Button for Add */
        .fab-add {
            position: fixed; bottom: 2.3rem; right: 1.4rem;
            background: linear-gradient(90deg,var(--primary),var(--accent));
            color: #fff;
            border: none;
            border-radius: 50%; width: 54px; height: 54px;
            font-size: 2.2rem;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 6px 18px rgba(59,130,246,0.16);
            cursor: pointer;
            z-index: 30;
        }
        .fab-add:active { transform: scale(0.96);}
        .fab-add i { font-size: 2.1rem;}

        /* Collapsible Section */
        .section-collapsible { margin-bottom: .6rem; }
        .section-header {
            font-weight: bold; font-size: 1.08em;
            background: #f1f5f9;
            padding: 10px 7px; border-radius: var(--radius);
            cursor: pointer; display: flex; align-items: center; justify-content: space-between;
            transition: background .2s;
        }
        .section-header:hover { background: #e0e7ff;}
        .section-body { padding: 6px 0 0 0; display: none; }
        .section-collapsible.active .section-body { display: block; animation: fadeIn .22s;}
        .section-collapsible.active .expand-icon { transform: rotate(90deg);}
        .expand-icon { transition: transform .23s; margin-left: 4px; }

        /* Modal (for category/user mgmt & expense edit) */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.27); z-index: 1001; display: flex; align-items: center; justify-content: center;
        }
        .modal {
            background: #fff; border-radius: var(--radius); padding: 1.3rem 1.1rem .8rem 1.1rem;
            box-shadow: 0 10px 36px rgba(37, 99, 235, 0.10);
            max-width: 97vw; width: 370px; min-width: 0;
            position: relative;
            animation: fadeIn .18s;
        }
        .modal-header {
            font-weight: 600; font-size: 1.15em; margin-bottom: .45rem; display: flex; align-items: center; gap: 8px;
        }
        .modal-close {
            position: absolute; right: 13px; top: 12px; background: none; border: none; font-size: 1.5em; color: var(--grey); cursor: pointer;
        }
        .modal-content { margin-bottom: 1.1rem;}
        .category-chip, .user-chip {
            display: inline-block; background: #e0e7ff; color: #374151; padding: 3px 11px; border-radius: 11px;
            font-size: .97em; margin: 2px 7px 2px 0;
        }
        .chip-remove {
            margin-left: 4px; color: var(--danger); cursor: pointer; font-size: 1.08em;
        }

        /* Analytics & Charts */
        .charts-grid {
            display: grid; grid-template-columns: 1fr; gap: 20px;
        }
        .chart-box { background: #fff; border-radius: var(--radius); padding: .6rem .3rem; }
        .chart-box h4 { font-size: 1.04em; font-weight: 600; margin-bottom: 5px; }

        /* Responsive */
        @media (min-width: 550px) {
            .charts-grid { grid-template-columns: 1fr 1fr;}
            .expenses-table-wrap { min-width: 0;}
        }
        @media (max-width: 520px) {
            .tab-content { padding: .4rem .1rem .9rem .1rem;}
            .budget-grid { flex-direction: column; gap: 5px;}
        }
        @media (max-width: 390px) {
            .modal { width: 96vw;}
            .budget-card { font-size: .96rem;}
        }

        /* Toast Message */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            min-width: 180px; max-width: 92vw; padding: 12px 20px; font-size: 1.06em;
            border-radius: var(--radius); z-index: 2002; color: #fff;
            box-shadow: 0 8px 36px rgba(0,0,0,0.15);
            animation: fadeIn .2s;
        }
        .toast.success { background: var(--success);}
        .toast.error { background: var(--danger);}
        .toast.info { background: var(--primary-dark);}
    </style>
</head>
<body>
    <div class="app-header">💰 Expense Tracker Pro</div>
    <div class="tabs" id="tabs">
        <button class="tab active" data-tab="dashboard"><i class="material-icons">dashboard</i>Dashboard</button>
        <button class="tab" data-tab="expenses"><i class="material-icons">receipt</i>Expenses</button>
        <button class="tab" data-tab="analytics"><i class="material-icons">analytics</i>Analytics</button>
        <button class="tab" data-tab="settings"><i class="material-icons">settings</i>Settings</button>
    </div>

    <!-- Dashboard -->
    <div class="tab-content active" id="dashboard">
        <div class="budget-grid">
            <div class="budget-card">
                <div>Total Budget</div>
                <div class="amount" id="totalBudget">₹0</div>
            </div>
            <div class="budget-card">
                <div>Total Spent</div>
                <div class="amount" id="totalSpent">₹0</div>
            </div>
            <div class="budget-card">
                <div>Remaining</div>
                <div class="amount" id="remainingBudget">₹0</div>
            </div>
        </div>
        <div class="progress-bar-wrap">
            <div class="progress-bar"><div class="progress-fill" id="budgetProgress"></div></div>
            <div class="progress-text" id="progressText"></div>
        </div>
        <div class="form-row">
            <input type="number" id="newBudget" placeholder="Set new monthly budget" min="0">
            <button class="btn success" onclick="setBudget()">Set</button>
            <button class="btn secondary" onclick="resetBudget()">Reset</button>
        </div>
        <!-- Add Expense button floats, see below -->
    </div>

    <!-- Expenses -->
    <div class="tab-content" id="expenses">
        <div class="section-collapsible active">
            <div class="section-header" onclick="toggleCollapsible(this)">
                <span>Recent Expenses</span>
                <span class="expand-icon"><i class="material-icons">chevron_right</i></span>
            </div>
            <div class="section-body">
                <div style="display:flex; align-items:center; gap:7px; margin-bottom:7px;">
                    <button class="btn small danger" onclick="deleteSelectedExpenses()">Delete Selected</button>
                    <button class="btn small" onclick="downloadCSV()">Export CSV</button>
                    <button class="btn small" onclick="downloadPDF()">Export PDF</button>
                    <span id="selectedCount" style="font-size:.98em;color:var(--grey);"></span>
                </div>
                <div class="expenses-table-wrap">
                    <table class="expenses-table" id="expensesTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" class="bulk-checkbox" onchange="toggleSelectAll(this)"></th>
                                <th>Date</th>
                                <th>User</th>
                                <th>Category</th>
                                <th>Vendor</th>
                                <th>₹</th>
                                <th>Note</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics -->
    <div class="tab-content" id="analytics">
        <div class="section-collapsible active">
            <div class="section-header" onclick="toggleCollapsible(this)">
                <span>Spending Analytics</span>
                <span class="expand-icon"><i class="material-icons">chevron_right</i></span>
            </div>
            <div class="section-body">
                <div class="charts-grid">
                    <div class="chart-box">
                        <h4>By Category</h4>
                        <canvas id="categoryPieChart" height="180"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4>Monthly Trend</h4>
                        <canvas id="monthlyTrendChart" height="180"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4>By User</h4>
                        <canvas id="userSpendingChart" height="180"></canvas>
                    </div>
                    <div class="chart-box">
                        <h4>Transaction Count</h4>
                        <canvas id="categoryCountChart" height="180"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings -->
    <div class="tab-content" id="settings">
        <div class="section-collapsible active">
            <div class="section-header" onclick="toggleCollapsible(this)">
                <span>Manage Categories & Users</span>
                <span class="expand-icon"><i class="material-icons">chevron_right</i></span>
            </div>
            <div class="section-body">
                <button class="btn small" onclick="openCategoryModal()">Edit Categories</button>
                <button class="btn small" onclick="openUserModal()">Edit Users</button>
            </div>
        </div>
    </div>

    <!-- Floating Action Button for Add -->
    <button class="fab-add" id="addExpenseFab" onclick="openExpenseModal()"><i class="material-icons">add</i></button>

    <!-- Modals -->
    <div id="modalRoot"></div>
    <div id="toast"></div>

    <script>
        // ----- Data Storage Keys -----
        const STORAGE = {
            EXPENSES: "exp_trk_expenses",
            BUDGET: "exp_trk_budget",
            CATEGORIES: "exp_trk_categories",
            USERS: "exp_trk_users"
        };

        // ----- Defaults -----
        const DEFAULT_CATEGORIES = [
            "Grocery", "Bills", "Travelling", "Food", "Medical", "EMI", "Investment",
            "Shopping", "Entertainment", "Personal Care", "Education", "Gifts/Donations",
            "Home Maintenance", "Transportation", "Utilities", "Others"
        ];
        const DEFAULT_USERS = ["Akshay", "Achal"];

        // ----- State -----
        let expenses = [];
        let budget = 0;
        let categories = [];
        let users = [];
        let selectedExpenseIds = [];
        let editExpenseId = null;

        // ----- Initialization -----
        document.addEventListener('DOMContentLoaded', function() {
            loadState();
            renderBudget();
            renderExpensesTable();
            renderCharts();
            setupTabs();
        });

        // ----- Tabs -----
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.onclick = function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.getAttribute('data-tab')).classList.add('active');
                    if(tab.getAttribute('data-tab') === 'analytics') renderCharts();
                    if(tab.getAttribute('data-tab') === 'expenses') renderExpensesTable();
                    if(tab.getAttribute('data-tab') === 'dashboard') renderBudget();
                }
            });
        }

        // ----- Collapsible Sections -----
        function toggleCollapsible(el) {
            const parent = el.closest('.section-collapsible');
            parent.classList.toggle('active');
        }

        // ----- State Management -----
        function saveState() {
            localStorage.setItem(STORAGE.EXPENSES, JSON.stringify(expenses));
            localStorage.setItem(STORAGE.BUDGET, JSON.stringify(budget));
            localStorage.setItem(STORAGE.CATEGORIES, JSON.stringify(categories));
            localStorage.setItem(STORAGE.USERS, JSON.stringify(users));
        }
        function loadState() {
            try {
                expenses = JSON.parse(localStorage.getItem(STORAGE.EXPENSES)) || [];
            } catch { expenses = []; }
            try {
                budget = JSON.parse(localStorage.getItem(STORAGE.BUDGET)) || 0;
            } catch { budget = 0; }
            try {
                categories = JSON.parse(localStorage.getItem(STORAGE.CATEGORIES)) || DEFAULT_CATEGORIES.slice();
            } catch { categories = DEFAULT_CATEGORIES.slice(); }
            try {
                users = JSON.parse(localStorage.getItem(STORAGE.USERS)) || DEFAULT_USERS.slice();
            } catch { users = DEFAULT_USERS.slice(); }
        }

        // ----- Budget -----
        function renderBudget() {
            document.getElementById('totalBudget').textContent = "₹" + budget.toLocaleString("en-IN");
            const currentMonth = new Date().toISOString().slice(0,7);
            const spent = expenses.filter(e=>e.date.startsWith(currentMonth)).reduce((t,e)=>t+Number(e.amount),0);
            document.getElementById('totalSpent').textContent = "₹" + spent.toLocaleString("en-IN");
            document.getElementById('remainingBudget').textContent = "₹" + (budget-spent).toLocaleString("en-IN");
            // Progress
            const percent = budget ? Math.min(100, (spent/budget)*100) : 0;
            const pf = document.getElementById('budgetProgress');
            pf.style.width = percent+"%";
            pf.className = 'progress-fill';
            if(percent >= 90) pf.classList.add('danger');
            else if(percent >= 70) pf.classList.add('warning');
            document.getElementById('progressText').textContent = `Used: ${percent.toFixed(1)}%`;
        }
        function setBudget() {
            let val = parseFloat(document.getElementById('newBudget').value);
            if(isNaN(val) || val<0) { showToast("Invalid budget", "error"); return;}
            budget = val;
            saveState(); renderBudget();
            document.getElementById('newBudget').value = "";
            showToast("Budget updated!","success");
        }
        function resetBudget() {
            if(!confirm("Reset budget to zero?")) return;
            budget = 0;
            saveState(); renderBudget();
            showToast("Budget reset.","success");
        }

        // ----- Expense CRUD -----
        function openExpenseModal(expense=null) {
            editExpenseId = expense && expense.id ? expense.id : null;
            showExpenseModal(expense);
        }

        function showExpenseModal(expense) {
            const root = document.getElementById('modalRoot');
            root.innerHTML = `
                <div class="modal-backdrop">
                <div class="modal" id="expenseModal">
                    <button class="modal-close" onclick="closeModal()"><i class="material-icons">close</i></button>
                    <div class="modal-header">${expense?"Edit":"Add"} Expense</div>
                    <div class="modal-content">
                        <div class="form-group">
                            <label>User</label>
                            <select id="expUser">${users.map(u=>`<option${expense&&expense.recordedBy===u?" selected":""}>${u}</option>`)}</select>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="expCategory">${categories.map(c=>`<option${expense&&expense.category===c?" selected":""}>${c}</option>`)}</select>
                        </div>
                        <div class="form-group">
                            <label>Vendor</label>
                            <input type="text" id="expVendor" value="${expense?escapeHtml(expense.vendor):""}" placeholder="Vendor">
                        </div>
                        <div class="form-group">
                            <label>Amount (₹)</label>
                            <input type="number" id="expAmount" value="${expense?expense.amount:""}" min="0" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="expDate" value="${expense?expense.date:todayStr()}">
                        </div>
                        <div class="form-group">
                            <label>Note (optional)</label>
                            <textarea id="expNote" rows="2" placeholder="Note">${expense?escapeHtml(expense.note):""}</textarea>
                        </div>
                    </div>
                    <button class="btn success" onclick="saveExpense()">Save</button>
                </div>
                </div>`;
        }
        function closeModal() { document.getElementById('modalRoot').innerHTML = "";}
        function saveExpense() {
            // Validate
            let user = document.getElementById('expUser').value;
            let cat = document.getElementById('expCategory').value;
            let vend = document.getElementById('expVendor').value.trim();
            let amt = parseFloat(document.getElementById('expAmount').value);
            let date = document.getElementById('expDate').value;
            let note = document.getElementById('expNote').value.trim();
            if(!user||!cat||!vend||isNaN(amt)||amt<=0||!date) {
                showToast("Fill all fields correctly","error"); return;
            }
            if(editExpenseId) {
                // Edit
                let ix = expenses.findIndex(e=>e.id===editExpenseId);
                if(ix!==-1) {
                    expenses[ix]={...expenses[ix],recordedBy:user,category:cat,vendor:vend,amount:amt,date,note};
                }
                showToast("Expense updated","success");
            } else {
                // Add
                expenses.push({
                    id: (Date.now()+Math.random()).toString(36),
                    recordedBy: user,
                    category: cat,
                    vendor: vend,
                    amount: amt,
                    date, note,
                    timestamp: Date.now()
                });
                showToast("Expense added!","success");
            }
            saveState();
            closeModal();
            renderBudget(); renderExpensesTable(); renderCharts();
        }
        function escapeHtml(txt) { return (txt||"").replace(/[<>&"']/g, m=>({"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;"}[m])); }
        function todayStr() { return (new Date()).toISOString().slice(0,10); }

        // ----- Expenses Table -----
        function renderExpensesTable() {
            selectedExpenseIds = [];
            let tbody = document.querySelector("#expensesTable tbody");
            let rows = expenses.slice().sort((a,b)=>b.timestamp-a.timestamp).map(e=>compactExpenseRow(e)).join('');
            if(!rows) rows = `<tr><td colspan="8" style="text-align:center;color:#b91c1c;padding:20px;">No expenses yet.</td></tr>`;
            tbody.innerHTML = rows;
            updateSelectedCount();
        }
        function compactExpenseRow(e) {
            return `
                <tr data-id="${e.id}" class="compact-row${selectedExpenseIds.includes(e.id)?" selected":""}">
                    <td><input type="checkbox" class="bulk-checkbox" onchange="selectExpense('${e.id}',this)" ${selectedExpenseIds.includes(e.id)?"checked":""}></td>
                    <td>${formatDate(e.date)}</td>
                    <td><span class="user-pill">${escapeHtml(e.recordedBy)}</span></td>
                    <td>${escapeHtml(e.category)}</td>
                    <td>${escapeHtml(e.vendor)}</td>
                    <td class="amount">₹${(+e.amount).toLocaleString("en-IN")}</td>
                    <td class="note" title="${escapeHtml(e.note)}">${escapeHtml(e.note)}</td>
                    <td class="actions">
                        <button class="btn small" onclick="openExpenseModal(getExpenseById('${e.id}'))"><i class="material-icons" style="font-size:1.04em;">edit</i></button>
                        <button class="btn small danger" onclick="deleteExpense('${e.id}')"><i class="material-icons" style="font-size:1.04em;">delete</i></button>
                    </td>
                </tr>`;
        }
        function getExpenseById(id) { return expenses.find(e=>e.id===id);}
        function deleteExpense(id) {
            if(!confirm("Delete this expense?")) return;
            expenses = expenses.filter(e=>e.id!==id);
            saveState();
            renderExpensesTable(); renderBudget(); renderCharts();
            showToast("Deleted.","success");
        }
        function selectExpense(id, cb) {
            if(cb.checked) selectedExpenseIds.push(id);
            else selectedExpenseIds = selectedExpenseIds.filter(x=>x!==id);
            updateSelectedCount();
        }
        function toggleSelectAll(cb) {
            if(cb.checked) {
                selectedExpenseIds = expenses.map(e=>e.id);
            } else {
                selectedExpenseIds = [];
            }
            renderExpensesTable();
            document.getElementById('selectAll').checked = cb.checked;
        }
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent =
                selectedExpenseIds.length ? selectedExpenseIds.length+" selected" : "";
            let all = document.getElementById('selectAll');
            if(all) all.checked = selectedExpenseIds.length === expenses.length && expenses.length>0;
        }
        function deleteSelectedExpenses() {
            if(selectedExpenseIds.length===0) { showToast("Select expenses first","info"); return;}
            if(!confirm("Delete "+selectedExpenseIds.length+" selected expenses?")) return;
            expenses = expenses.filter(e=>!selectedExpenseIds.includes(e.id));
            saveState(); renderExpensesTable(); renderBudget(); renderCharts();
            showToast("Bulk delete done","success");
        }

        // ----- CSV/PDF Export -----
        function downloadCSV() {
            if(!expenses.length) { showToast("No data to export","info"); return; }
            let csv = "Date,User,Category,Vendor,Amount,Note\n"+
                expenses.map(e=>[
                    `"${e.date}"`,
                    `"${e.recordedBy}"`,
                    `"${e.category}"`,
                    `"${e.vendor}"`,
                    e.amount,
                    `"${(e.note||"").replace(/"/g,'""')}"`
                ].join(",")).join("\n");
            let blob = new Blob([csv], { type: 'text/csv' });
            let url = URL.createObjectURL(blob);
            let a = document.createElement("a");
            a.href = url; a.download = "expenses_"+(new Date().toISOString().slice(0,10))+".csv";
            document.body.appendChild(a); a.click(); a.remove();
        }
        function downloadPDF() {
            if(!expenses.length) { showToast("No data to export","info"); return; }
            const { jsPDF } = window.jspdf;
            let doc = new jsPDF();
            doc.setFontSize(18); doc.text("Expense Report", 15, 18);
            doc.setFontSize(12);
            doc.text(`Total Expenses: ₹${expenses.reduce((s,e)=>s+Number(e.amount),0).toLocaleString("en-IN")}`,15,28);
            doc.text(`Generated: ${(new Date()).toLocaleDateString("en-IN")}`, 15, 34);
            doc.autoTable({
                head: [["Date","User","Category","Vendor","Amount","Note"]],
                body: expenses.map(e=>[formatDate(e.date),e.recordedBy,e.category,e.vendor,"₹"+(+e.amount).toLocaleString("en-IN"),e.note||""]),
                startY: 40,
                styles: { fontSize: 10 },
                columnStyles: {0:{cellWidth:18},4:{halign:'right'}}
            });
            doc.save("expenses_"+(new Date().toISOString().slice(0,10))+".pdf");
        }

        // ----- Charts & Analytics -----
        let chartInstances = {};
        function renderCharts() {
            // Clean up old charts
            Object.values(chartInstances).forEach(c=>{try{c.destroy();}catch{}});
            // Pie: By Category
            let catAgg = {};
            expenses.forEach(e=>{catAgg[e.category]= (catAgg[e.category]||0) + Number(e.amount);});
            let cats = Object.keys(catAgg), catVals = Object.values(catAgg);
            chartInstances.catPie = new Chart(document.getElementById('categoryPieChart').getContext('2d'), {
                type:'pie', data:{
                    labels: cats, datasets: [{data: catVals, backgroundColor: genColors(cats.length)}]
                },
                options:{
                    plugins:{legend:{position:'bottom'}, datalabels:{
                        color:'#fff', font:{weight:'bold'}, formatter:(v,ctx)=>{
                            let s = ctx.dataset.data.reduce((a,b)=>a+b,0);
                            let p = (v/s*100).toFixed(1); return p>6?p+"%":"";
                        }
                    }}
                }, plugins:[ChartDataLabels]
            });
            // Monthly Trend
            let monAgg = {};
            expenses.forEach(e=>{
                let m = e.date.slice(0,7); monAgg[m]= (monAgg[m]||0)+Number(e.amount);
            });
            let mons = Object.keys(monAgg).sort(), monVals = mons.map(m=>monAgg[m]);
            chartInstances.monBar = new Chart(document.getElementById('monthlyTrendChart').getContext('2d'),{
                type:'bar', data:{
                    labels: mons.map(m=>m.replace("-","/")), datasets:[{label:"Spent (₹)",data:monVals}]
                },
                options:{
                    plugins:{legend:{display:false}},
                    scales:{y:{beginAtZero:true}},
                }
            });
            // User Spend
            let userAgg = {};
            expenses.forEach(e=>{userAgg[e.recordedBy]=(userAgg[e.recordedBy]||0)+Number(e.amount);});
            let us = Object.keys(userAgg), usVals = Object.values(userAgg);
            chartInstances.userBar = new Chart(document.getElementById('userSpendingChart').getContext('2d'),{
                type:'bar', data:{
                    labels:us, datasets:[{label:"Spent (₹)",data:usVals,backgroundColor:genColors(us.length)}]
                },
                options:{
                    plugins:{legend:{display:false}},
                    scales:{y:{beginAtZero:true}}
                }
            });
            // Category Count
            let catCount = {};
            expenses.forEach(e=>{catCount[e.category]=(catCount[e.category]||0)+1;});
            let ccats = Object.keys(catCount), ccVals = Object.values(catCount);
            chartInstances.catCount = new Chart(document.getElementById('categoryCountChart').getContext('2d'),{
                type:'bar', data:{
                    labels:ccats, datasets:[{label:"Transactions",data:ccVals,backgroundColor:genColors(ccats.length)}]
                }, options:{
                    plugins:{legend:{display:false}},
                    scales:{y:{beginAtZero:true,stepSize:1}}
                }
            });
        }
        function genColors(n) {
            const palette = [
                "#3b82f6","#6366f1","#f59e42","#ef4444","#10b981","#f472b6","#a21caf",
                "#06b6d4","#db2777","#facc15","#14b8a6","#f87171","#a3e635","#eab308","#818cf8"
            ];
            return Array.from({length:n},(_,i)=>palette[i%palette.length]);
        }

        // ----- Categories/Users -----
        function openCategoryModal() {
            showModal("Edit Categories", categories.map((cat,i)=>`
                <span class="category-chip">${escapeHtml(cat)} <span class="chip-remove" onclick="removeCategory(${i})">&times;</span></span>
            `).join('')+`
                <div class="form-row">
                    <input id="catAddInput" placeholder="Add new category..." onkeydown="if(event.key==='Enter'){addCategory()}">
                    <button class="btn small" onclick="addCategory()">Add</button>
                </div>
            `, null, "catModal");
        }
        function addCategory() {
            let inp = document.getElementById('catAddInput');
            let val = (inp.value||"").trim();
            if(!val) return;
            if(categories.includes(val)) { showToast("Exists","info"); return;}
            categories.push(val);
            saveState(); closeModal(); openCategoryModal();
        }
        function removeCategory(i) {
            if(categories.length<=1) { showToast("Need at least one","info"); return;}
            if(!confirm("Delete category?")) return;
            let cat = categories[i];
            expenses = expenses.filter(e=>e.category!==cat);
            categories.splice(i,1);
            saveState(); closeModal(); openCategoryModal(); renderExpensesTable(); renderCharts();
        }
        function openUserModal() {
            showModal("Edit Users", users.map((u,i)=>`
                <span class="user-chip">${escapeHtml(u)} <span class="chip-remove" onclick="removeUser(${i})">&times;</span></span>
            `).join('')+`
                <div class="form-row">
                    <input id="userAddInput" placeholder="Add new user..." onkeydown="if(event.key==='Enter'){addUser()}">
                    <button class="btn small" onclick="addUser()">Add</button>
                </div>
            `, null, "userModal");
        }
        function addUser() {
            let inp = document.getElementById('userAddInput');
            let val = (inp.value||"").trim();
            if(!val) return;
            if(users.includes(val)) { showToast("Exists","info"); return;}
            users.push(val);
            saveState(); closeModal(); openUserModal();
        }
        function removeUser(i) {
            if(users.length<=1) { showToast("Need at least one","info"); return;}
            if(!confirm("Delete user?")) return;
            let user = users[i];
            expenses = expenses.filter(e=>e.recordedBy!==user);
            users.splice(i,1);
            saveState(); closeModal(); openUserModal(); renderExpensesTable(); renderCharts();
        }

        // ----- Modal Reuse -----
        function showModal(title, content, saveCb, id) {
            document.getElementById('modalRoot').innerHTML =
                `<div class="modal-backdrop"><div class="modal" id="${id||''}">
                    <button class="modal-close" onclick="closeModal()"><i class="material-icons">close</i></button>
                    <div class="modal-header">${title}</div>
                    <div class="modal-content">${content}</div>
                </div></div>`;
        }

        // ----- Toast/Message -----
        function showToast(msg, type="success") {
            let t = document.getElementById('toast');
            t.innerHTML = `<div class="toast ${type}">${msg}</div>`;
            setTimeout(()=>{t.innerHTML='';},2200);
        }

        // ----- Date Utility -----
        function formatDate(str) {
            if(!str) return "";
            let [y,m,d]=str.split('-');
            return [d,m,y].join('-');
        }
    </script>
</body>
</html>
